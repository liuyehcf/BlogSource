---
title: 保证消息的可靠性
date: 2017-08-01 10:08:26
tags: 
- 摘录
categories: 
- 分布式
- 消息中间件
---

__阅读更多__

<!--more-->

# 1 前言

消息从发送端应用到接收端应用，中间有三个阶段需要保证可靠，分别是：

1. 消息发送者把消息发送到消息中间件
1. 消息中间件把消息存入消息存储
1. 消息中间件把消息投递给消息接收者

我们要保证这三个阶段都可靠，才能够保证最终消息的可靠

![fig1](/images/保证消息的可靠性/fig1.png)

# 2 消息发送端可靠性的保证

这是消息投递的第一步，这一步并不复杂，需要注意消息发送者和消息中间件之间的调用返回结果的清晰设定，以及对于返回结果的全面处理

发送者需要把消息的发送结果准确地传给应用，应用才能进行相关的判断和逻辑处理。消息从发送者发送到消息中间件，只有当消息中间件及时、明确地返回成功，才能确认消息可靠到达消息中间件了；返回错误、出现异常、超时等情况，都表示消息发送到消息中间件这个动作失败。这里需要注意的是对异常的处理，可能出现问题的是在不注意的情况下吃掉了异常，从而导致错误的判断结果

# 3 消息存储的可靠性保证

消息从发送者发送消息到中间件后，消息存储是一个非常重要的环节。当消息从发送者端发送出来后，消息的可靠性保证就靠存储了

此时会面临两个选择

1. 持久存储部分的代码完全自主实现
1. 利用现有的存储系统实现

自主实现持久存储的功能需要慎重。一个成熟的存储系统是需要长时间的努力、沉淀和考验的。除非有充分的理由，否则不建议完全重新实现一个持久存储。如果针对特定的场景，自主实现能够很好地提升性能、降低成本，或者有其他一些好处，那么还是值得开发定制的存储系统的

采用现有的存储系统会面临比较多的选择，有传统的关系型数据库、分布式文件系统和NoSQL产品，这些类型的产品各有所长，需要在保证存储可靠性的基础上，依据对消息存储的需求来选择

# 4 消息投递的可靠性保证

最后一步是消息的投递，这一步和发送者发消息类似，处理相对简单。特别需要注意的是，消息中间件需要显式地收到接收者确认消息处理完毕的信号才能删除消息。__消息中间件不能够依据网络层判断消息是否已经送到接收者，进而决定消息是否删除，而一定要从应用层的响应入手__

消息接收者需要特别注意的是，不能在收到消息、业务没有处理完成时去确认消息。此外，需要特别注意的仍然是消息接收者在处理消息的过程中对于异常的处理，千万不要吃掉异常然后确认消息处理成功，这样就会"丢失"消息了，在实战中也多次发生过这样的例子

## 4.1 投递处理的优化

在投递处理时，不同的投递处理方式会产生不同的结果

在进行投递时一般采用多线程的方式处理

> 一种方式是每个线程处理一个消息并且等待处理结束后在进行下一条消息的处理。每个线程处理一条消息时，会得到需要接收该消息的订阅者集群Id列表，然后从每个订阅者集群Id中选择一个连接来处理；消息投递后需要等待结果，然后统一更新消息表中的消息状态。这种方式在正常情况下没有问题，而遇到异常情况时，例如订阅者集群中有一个很慢的订阅者，负责投递的所有线程会慢慢地被毒死，因为都需要等待这个慢的订阅者的返回

> 另一种方式是把消息处理结果返回的处理工作放到另外的线程池中来完成，也就是投递线程完成消息到网络的投递后就可以接着处理下一个消息，保证投递环节不会被堵死。而等待返回结果的消息先会放在内存中，不占用线程资源，等有了最后的结果时，再放入另外的线程池中处理。这种方式把占用线程池的等待方式变为了靠网络收到消息处理结果后的主动响应方式

# 5 参考

__本篇博客摘录、整理自以下博文。若存在版权侵犯，请及时联系博主(邮箱：liuyehcf#163.com，#替换成@)，博主将在第一时间删除__

* 大型网站系统与Java中间件实践
