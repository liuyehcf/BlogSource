---
title: HTTP协议
date: 2017-07-09 22:53:32
tags: 
- 摘录
categories: 
- Web
- HTTP
---

__阅读更多__

<!--more-->

# 1 前言

# 2 HTTP协议

协议是指计算机通信网络中两台计算机之间进行通信所必须共同遵守的规定或规则，超文本传输协议(HTTP)是一种通信协议，它允许将超文本标记语言(HTML)文档从Web服务器传送到客户端的浏览器

HTTP协议的主要特点可概括如下：

1. __支持客户/服务器模式__
1. __简单快速__：客户向服务器请求服务时，只需传送请求方法和路径。请求方法常用的有GET、HEAD、POST。每种方法规定了客户与服务器联系的类型不同。由于HTTP协议简单，使得HTTP服务器的程序规模小，因而通信速度很快
1. __灵活__：HTTP允许传输任意类型的数据对象。正在传输的类型由Content-Type加以标记
1. __非持久连接(1.0)/持久连接(1.1)__：__`HTTP1.0`使用的是非持久连接__，主要缺点是客户端必须为每一个待请求的对象建立并维护一个新的连接，即每请求一个文档就要有两倍RTT的开销。因为同一个页面可能存在多个对象，所以非持久连接可能使一个页面的下载变得十分缓慢，而且这种短连接增加了网络传输的负担。__`HTTP1.1`使用持久连接keepalive__，所谓持久连接，就是服务器在发送响应后仍然在一段时间内保持这条连接，允许在同一个连接中存在多次数据请求和响应，即在持久连接情况下，服务器在发送完响应后并不关闭TCP连接，而客户端可以通过这个连接继续请求其他对象
    * __`HTTP/1.1`协议的持久连接有两种方式：__
        * 非流水线方式：客户在收到前一个响应后才能发出下一个请求
        * 流水线方式：客户在收到HTTP的响应报文之前就能接着发送新的请求报文
1. __无状态__：HTTP协议是无状态协议。无状态是指协议对于事务处理没有记忆能力。缺少状态意味着如果后续处理需要前面的信息，则它必须重传，这样可能导致每次连接传送的数据量增大。另一方面，在服务器不需要先前信息时它的应答就较快

## 2.1 Web服务器，浏览器，代理服务器

当我们打开浏览器，在地址栏中输入URL，然后我们就看到了网页。原理是怎样的呢？

实际上我们输入URL后，我们的浏览器给Web服务器发送了一个Request，Web服务器接到Request后进行处理，生成相应的Response，然后发送给浏览器，浏览器解析Response中的HTML，这样我们就看到了网页

我们的Request有可能是经过了代理服务器，最后才到达Web服务器的。代理服务器就是网络信息的中转站，有什么功能呢？

1. 提高访问速度，大多数的代理服务器都有缓存功能
1. 突破限制，也就是FQ了
1. 隐藏身份

## 2.2 HTTP-URL

URL(Uniform Resource Locator)是一种特殊类型的URI，URL地址用于描述一个网络上的资源，基本格式如下
`schema://host[:port#]/path/.../[?query-string][#anchor]`

* __scheme__：指定低层使用的协议(例如：http，https，ftp)
* __host__：HTTP服务器的IP地址或者域名
* __port#__：HTTP服务器的默认端口是80，这种情况下端口号可以省略。如果使用了别的端口，必须指明，例如http://www.cnblogs.com:8080/
* __path__：访问资源的路径
* __query-string__：发送给http服务器的数据
* __anchor__：锚

下面是一个例子

```
http://www.mywebsite.com/sj/test/test.aspx?name=sviergn&x=true#stuff

Schema:                 http
host:                   www.mywebsite.com
path:                   /sj/test/test.aspx
Query String:           name=sviergn&x=true
Anchor:                 stuff
```

## 2.3 HTTP-Request

## 2.4 HTTP-Response

## 2.5 HTTP-Header

## 2.6 打开一个网页需要浏览器发送很多次Request

打开一个网页可能会经历如下过程

1. 当你在浏览器输入URL http://www.cnblogs.com 的时候，浏览器发送一个Request去获取 http://www.cnblogs.com 的html。服务器把Response发送回给浏览器
1. 浏览器分析Response中的HTML，发现其中引用了很多其他文件，比如图片，CSS文件，JS文件
1. 浏览器会自动再次发送Request去获取图片，CSS文件，或者JS文件
1. 等所有的文件都下载成功后。网页就被显示出来了

## 2.7 状态码

Response消息中的第一行叫做状态行，由HTTP协议版本号，状态码，状态消息三部分组成

状态码用来告诉HTTP客户端，HTTP服务器是否产生了预期的Response.

HTTP/1.1中定义了5类状态码，状态码由三位数字组成，第一个数字定义了响应的类别

* __1XX  提示信息__：表示请求已被成功接收，继续处理
* __2XX  成功__：表示请求已被成功接收，理解，接受
    * 200 OK：最常见的就是成功响应状态码200了，这表明该请求被成功地完成，所请求的资源发送回客户端
* __3XX  重定向__：要完成请求必须进行更进一步的处理
    * 302 Found：重定向，新的URL会在response中的Location中返回，浏览器将会自动使用新的URL发出新的Request
    * 304 Not Modified：代表上次的文档已经被缓存了，还可以继续使用
* __4XX  客户端错误__：请求有语法错误或请求无法实现
    * 400 Bad Request：客户端请求与语法错误，不能被服务器所理解
    * 403 Forbidden：服务器收到请求，但是拒绝提供服务
    * 404 Not Found：请求资源不存在（输错了URL）
* __5XX  服务器端错误__：服务器未能实现合法的请求
    * 500 Internal Server Error：服务器发生了不可预期的错误
    * 503 Server Unavailable：服务器当前不能处理客户端的请求，一段时间后可能恢复正常

# 3 HTTP方法的安全性和幂等性

Http协议规定了不同方法的安全特性和幂等特性，作为服务提供者的服务器必需为客户端提供这些特性

* __安全性__：仅指该方法的多次调用不会产生副作用，不涉及传统意义上的"安全"，这里的副作用是指资源状态。即，安全的方法不会修改资源状态，尽管多次调用的返回值可能不一样(被其他非安全方法修改过)
* __幂等性__：是指该方法多次调用返回的效果(形式)一致，客户端可以重复调用并且期望同样的结果。幂等的含义类似于编程语言中的setter方法，一次调用和多次调用产生的效果是一致的，都是对一个变量进行赋值。安全性和幂等性含义有些接近，容易搞混

HTTP方法的安全性幂等性见下表

| 方法名 | 安全性 | 幂等性 |
|:--|:--:|:--:|
| GET | 是 | 是 |
| HEAD | 是 | 是 |
| OPTIONS | 是 | 是 |
| DELETE | 否 | 是 |
| PUT | 否 | 是 |
| POST | 否 | 否 |

* 可以认为安全的方法都是只读的方法(GET，HEAD，OPTIONS)，不会改变资源状态，显然，这三个方法也是幂等的
* DELETE方法的语义表示删除服务器上的一个资源，第一次删除成功后该资源就不存在了，资源状态改变了，所以DELETE方法不具备安全特性。然而HTTP协议规定DELETE方法是幂等的，每次删除该资源都要返回状态码200 OK，服务器端要实现幂等的DELETE方法，必须记录所有已删除资源的元数据(Metadata)，否则，第二次删除后返回的响应码就会类似404 Not Found了
* PUT和POST方法语义中都有修改资源状态的意思，因此都不是安全的。但是PUT方法是幂等的，POST方法不是幂等的，这么设计的理由是
    * HTTP协议规定，__POST方法修改资源状态时，URL指示的是该资源的父级资源，待修改资源的ID信息在请求体中携带__
    * 而PUT方法修改资源状态时，URL直接指示待修改资源。因此，同样是创建资源，重复提交POST请求可能产生两个不同的资源，而重复提交PUT请求只会对其URL中指定的资源起作用，也就是只会创建一个资源

# 4 GET与POST

POST和GET本质上没有区别，一个用于传递数据，另一个用于修改数据。GET具有安全性和幂等性，POST不具有安全性也不具有幂等性

## 4.1 GET和POST与数据如何传递没有关系

GET和POST是由HTTP协议定义的。在HTTP协议中，Method和Data(URL，Body，Header)是正交的两个概念，也就是说，使用哪个Method与应用层的数据如何传输是没有相互关系的

HTTP没有要求POST方法必须将数据放在BODY中，同样没有要求GET方法必须将数据放在URL中而不能放在BODY中

而上述这些(POST方法必须将数据放在BODY中，GET方法必须将数据放在URL中而不能放在BODY中)只HTML标准对HTTP协议的用法的约定

## 4.2 HTTP协议对GET和POST都没有对长度的限制

HTTP协议明确地指出了，HTTP头和Body都没有长度的要求。而对于URL长度上的限制，有两方面的原因造成

* __浏览器__。据说早期的浏览器会对URL长度做限制。据说IE对URL长度会限制在2048个字符内(流传很广，而且无数同事都表示认同)。但我自己试了一下，我构造了90K的URL通过IE9访问live.com，是正常的。网上的东西，哪怕是Wikipedia上的，也不能信
* __服务器__。URL长了，对服务器处理也是一种负担。原本一个会话就没有多少数据，现在如果有人恶意地构造几个几M大小的URL，并不停地访问你的服务器。服务器的最大并发数显然会下降。另一种攻击方式是，把告诉服务器Content-Length是一个很大的数，然后只给服务器发一点儿数据，嘿嘿，服务器你就傻等着去吧。哪怕你有超时设置，这种故意的次次访问超时也能让服务器吃不了兜着走。有鉴于此，多数服务器出于安全啦、稳定啦方面的考虑，会给URL长度加限制。但是这个限制是针对所有HTTP请求的，与GET、POST没有关系

## 4.3 99%的人都理解错了HTTP中GET与POST的区别

GET和POST是HTTP请求的两种基本方法，要说它们的区别，接触过WEB开发的人都能说出一二，最直观的区别就是GET把参数包含在URL中，POST通过request body传递参数。当你在面试中被问到这个问题，你的内心充满了自信和喜悦

1. GET在浏览器回退时是无害的，而POST会再次提交请求
1. GET产生的URL地址可以被Bookmark，而POST不可以
1. GET请求会被浏览器主动cache，而POST不会，除非手动设置
1. GET请求只能进行url编码，而POST支持多种编码方式
1. GET请求参数会被完整保留在浏览器历史记录里，而POST中的参数不会被保留
1. GET请求在URL中传送的参数是有长度限制的，而POST么有
1. 对参数的数据类型，GET只接受ASCII字符，而POST没有限制
1. GET比POST更不安全，因为参数直接暴露在URL上，所以不能用来传递敏感信息
1. GET参数通过URL传递，POST放在Request body中

如果我告诉你GET和POST本质上没有区别你信吗？让我们扒下GET和POST的外衣，坦诚相见吧

* GET和POST是什么？HTTP协议中的两种发送请求的方法
* HTTP是什么？HTTP是基于TCP/IP的关于数据如何在万维网中如何通信的协议
* HTTP的底层是TCP/IP。所以GET和POST的底层也是TCP/IP，也就是说，GET/POST都是TCP链接。GET和POST能做的事情是一样一样的。你要给GET加上request body，给POST带上url参数，技术上是完全行的通的

那么，"标准答案"里的那些区别是怎么回事？在我大万维网世界中，TCP就像汽车，我们用TCP来运输数据，它很可靠，从来不会发生丢件少件的现象。但是如果路上跑的全是看起来一模一样的汽车，那这个世界看起来是一团混乱，送急件的汽车可能被前面满载货物的汽车拦堵在路上，整个交通系统一定会瘫痪。为了避免这种情况发生，交通规则HTTP诞生了。HTTP给汽车运输设定了好几个服务类别，有GET，POST，PUT，DELETE等等，HTTP规定，当执行GET请求的时候，要给汽车贴上GET的标签(设置method为GET)，而且要求把传送的数据放在车顶上(url中)以方便记录。如果是POST请求，就要在车上贴上POST的标签，并把货物放在车厢里。当然，你也可以在GET的时候往车厢内偷偷藏点货物，但是这是很不光彩;也可以在POST的时候在车顶上也放一些数据，让人觉得傻乎乎的。HTTP只是个行为准则，而TCP才是GET和POST怎么实现的基本。但是，我们只看到HTTP对GET和POST参数的传送渠道(url还是requrest body)提出了要求。"标准答案"里关于参数大小的限制又是从哪来的呢？在我大万维网世界中，还有另一个重要的角色：运输公司。不同的浏览器(发起http请求)和服务器(接受http请求)就是不同的运输公司。虽然理论上，你可以在车顶上无限的堆货物(url中无限加参数)。但是运输公司可不傻，装货和卸货也是有很大成本的，他们会限制单次运输量来控制风险，数据量太大对浏览器和服务器都是很大负担。业界不成文的规定是，(大多数)浏览器通常都会限制url长度在2K个字节，而(大多数)服务器最多处理64K大小的url。超过的部分，恕不处理。如果你用GET服务，在request body偷偷藏了数据，不同服务器的处理方式也是不同的，有些服务器会帮你卸货，读出数据，有些服务器直接忽略，所以，虽然GET可以带request body，也不能保证一定能被接收到哦

好了，现在你知道，GET和POST本质上就是TCP链接，并无差别。但是由于HTTP的规定和浏览器/服务器的限制，导致他们在应用过程中体现出一些不同

* GET和POST还有一个重大区别，简单的说：GET产生一个TCP数据包，POST产生两个TCP数据包
* 对于GET方式的请求，浏览器会把http header和data一并发送出去，服务器响应200(返回数据);
* 而对于POST，浏览器先发送header，服务器响应100 continue，浏览器再发送data，服务器响应200 OK(返回数据)
* 也就是说，GET只需要汽车跑一趟就把货送到了，而POST得跑两趟，第一趟，先去和服务器打个招呼"嗨，我等下要送一批货来，你们打开门迎接我"，然后再回头把货送过去。因为POST需要两步，时间上消耗的要多一点，看起来GET比POST更有效。因此Yahoo团队有推荐用GET替换POST来优化网站性能。但这是一个坑！跳入需谨慎。为什么
    * GET与POST都有自己的语义，不能随便混用
    * 据研究，在网络环境好的情况下，发一次包的时间和发两次包的时间差别基本可以无视。而在网络环境差的情况下，两次包的TCP在验证数据包完整性上，有非常大的优点
    * 并不是所有浏览器都会在POST中发送两次包，Firefox就只发送一次

## 4.4 何时用POST何时用GET

满足下列任一条件采用POST

1. 请求的结果有持续性的副作用，例如，数据库内添加新的数据行
1. 若使用GET方法，则表单上收集的数据可能让URL过长
1. 要传送的数据不是采用7位的ASCII编码

满足下列任一条件采用GET

1. 请求是为了查找资源，HTML表单数据仅用来帮助搜索
1. 请求结果无持续性的副作用
1. 收集的数据及HTML表单内的输入字段名称的总长不超过1024个字符

## 4.5 Web浏览器向Web服务器发送请求命令

一旦建立了TCP连接，Web浏览器就会向Web服务器发送请求命令。例如：`GET/sample/hello.jsp HTTP/1.1`

## 4.6 Web浏览器发送请求头信息

浏览器发送其请求命令之后，还要以头信息的形式向Web服务器发送一些别的信息，之后浏览器发送了一空白行来通知服务器，它已经结束了该头信息的发送

## 4.7 Web服务器应答

客户机向服务器发出请求后，服务器会客户机回送应答，`HTTP/1.1 200 OK`，应答的第一部分是协议的版本号和应答状态码

## 4.8 Web服务器发送应答头信息

正如客户端会随同请求发送关于自身的信息一样，服务器也会随同应答向用户发送关于它自己的数据及被请求的文档

## 4.9 Web服务器向浏览器发送数据

Web服务器向浏览器发送头信息后，它会发送一个空白行来表示头信息的发送到此为结束，接着，它就以Content-Type应答头信息所描述的格式发送用户所请求的实际数据

## 4.10 Web服务器关闭TCP连接

一般情况下，一旦Web服务器向浏览器发送了请求数据，它就要关闭TCP连接，然后如果浏览器或者服务器在其头信息加入了这行代码：`Connection:keep-alive`。TCP连接在发送后将仍然保持打开状态，于是，浏览器可以继续通过相同的连接发送请求。保持连接节省了为每个请求建立新连接所需的时间，还节约了网络带宽

# 5 参考

__本篇博客摘录、整理自以下博文。若存在版权侵犯，请及时联系博主(邮箱：liuyehcf#163.com，#替换成@)，博主将在第一时间删除__

* [HTTP协议详解](http://www.cnblogs.com/TankXiao/archive/2012/02/13/2342672.html#threeconcept)
* [前端必备HTTP技能之HTTP请求头响应头中常用字段详解](https://www.jianshu.com/p/6e86903d74f7)
