---
title: 操作系统实战-读书笔记
date: 2021-12-21 22:53:51
tags: 
- 摘录
categories: 
- Operating System
- Principle
---

**阅读更多**

<!--more-->

# 1 重点

**linux_kernel_map**

![4-1](/images/操作系统实战-读书笔记/4-1.png)

{% markmap %}
- Linux五大功能组件
    - 系统（System）
        - API接口：用于应用程序调用系统功能
        - 设备驱动模型：规范各种驱动程序的开发
        - 系统运行：完成系统启动初始化，电源管理等功能
        - 总线与设备驱动：各种驱动程序实现控制访问具体设备
        - I/O设备：物理硬件如PCI、USB总线等设备控制器
    - 进程（Processing）
        - 进程接口：创建进程、加载应用、处理信号等功能
        - 内核态线程：实现工作队列
        - 同步机制：实现了自旋锁、信号量、互斥锁、读写锁、RCU锁
        - 进程调度器：负责进程的调度，即给进程分配CPU使之运行
        - 中断处理：负责处理硬件中断、软件中断和管理中断控制器
        - CPU：负责执行所有代码指令
    - 内存（Memory）
        - 内存接口：使得应用能分配、释放内存空间，映射和共享内存
        - 虚拟内存：使得应用有统一、独立且比实际内存大的多的地址空间
        - 内存映射：负责建立页表、完成虚拟内存地址到物理内存地址的转换
        - 内存对象分配：如slab、slub，用内核自身数据结构对象的分配与释放
        - 物理内存管理：用于管理、分配、释放物理内存页
        - 物理内存：真实的机器内存条、MMU部件，DMA部件
    - 存储（Storage）
        - 存储接口：主要是实现文件和目录的读写访问
        - 虚拟文件系统：规范了真实文件系统，实现了文件、目录等抽象的结构
        - I/O Cache：实现了文件数据块的缓存、同步、交换等功能
        - 具体文件系统：实现具体的文件系统，如EXT4、XFS、NTFS等
        - 块设备层：是文件系统的支持，其特点是按照具体大小的块进行读写
        - 存储设备：如IDE、SATA、SCSI、NVME存储设备及对应的驱动程序
    - 网络（Network）
        - 套接字接口：实现网络连接，监听、绑定、访问等功能
        - 套接字：实现统一的网络访问方式
        - 网络协议：实现了UDP、TCP、IP等网络协议
        - 网络接口：实现网络数据的接受、发送缓冲区和队列
        - 网卡驱动：操作具体的网络设备
        - 网卡：具体的以太网卡、无线WIFI等设备
{% endmarkmap %}

**取指、访问内存数据**

* 代码段是由`CS`和`IP`确定的
* 栈段是由`SS`和`SP`段确定的

![5-1](/images/操作系统实战-读书笔记/5-1.jpeg)

# 2 Lession-10

## 2.1 Ubuntu-18.04.6

```sh
base_dir=/root/os
loop_device=/dev/loop20
mkdir -p ${base_dir}

# step1：生产虚拟硬盘
dd bs=512 if=/dev/zero of=${base_dir}/hd.img count=204800

# step2：格式化虚拟硬盘
#   2.1 将 hd.img 设置为回环设备
losetup ${loop_device} ${base_dir}/hd.img
#   2.2 格式化
mkfs.ext4 -q ${loop_device}

# step3：安装grub
mkdir -p ${base_dir}/hdisk
#   3.1 挂载硬盘文件
mount -o loop ${base_dir}/hd.img ${base_dir}/hdisk
mkdir -p ${base_dir}/hdisk/boot
#   3.2 安装
grub-install --boot-directory=${base_dir}/hdisk/boot --force --allow-floppy ${loop_device}
#   3.3 编写grub配置文件
cat > ${base_dir}/hdisk/boot/grub/grub.cfg << 'EOF'
menuentry 'HelloOS' {
insmod part_msdos
insmod ext2
set root='hd0,msdos1' #我们的硬盘只有一个分区所以是'hd0,msdos1'
multiboot2 /boot/HelloOS.eki #加载boot目录下的HelloOS.eki文件
boot #引导启动
}
set timeout_style=menu
if [ "${timeout}" = 0 ]; then
  set timeout=10 #等待10秒钟自动启动
fi
EOF

# step4：用VirtualBox的工具将文件格式转成 VDI
VBoxManage convertfromraw ${base_dir}/hd.img --format VDI ${base_dir}/hd.vdi

# step4：安装虚拟硬盘
#   4.1 SATA的硬盘其控制器是intelAHCI，其中 HelloOS 是虚拟机的名称
VBoxManage storagectl HelloOS --name "SATA" --add sata --controller IntelAhci --portcount 1
#   4.2 删除虚拟硬盘UUID并重新分配
VBoxManage closemedium disk ${base_dir}/hd.vdi
#   4.3 将虚拟硬盘挂到虚拟机的硬盘控制器，其中 HelloOS 是虚拟机的名称
VBoxManage storageattach HelloOS --storagectl "SATA" --port 1 --device 0 --type hdd --medium ${base_dir}/hd.vdi

# step5：启动虚拟机，其中 HelloOS 是虚拟机的名称
VBoxManage startvm HelloOS
```

## 2.2 CentOS-7.9-2009

```sh
base_dir=/root/os
mkdir -p ${base_dir}

# step1：生产虚拟硬盘
dd bs=512 if=/dev/zero of=${base_dir}/hd.img count=204800

# step2：格式化虚拟硬盘
#   2.1 将 hd.img 设置为回环设备
losetup /dev/loop0 ${base_dir}/hd.img
#   2.2 格式化
mkfs.ext4 -q /dev/loop0

# step3：安装grub
mkdir -p ${base_dir}/hdisk
#   3.1 挂载硬盘文件，mount这步执行完后，出现了另一个回环设备 /dev/loop1，不知道为啥
mount -o loop ${base_dir}/hd.img ${base_dir}/hdisk
mkdir -p ${base_dir}/hdisk/boot
#   3.2 安装，这里要用 /dev/loop1 否则会报错
grub2-install --boot-directory=${base_dir}/hdisk/boot --force --allow-floppy /dev/loop1
#   3.3 编写grub配置文件
cat > ${base_dir}/hdisk/boot/grub2/grub.cfg << 'EOF'
menuentry 'HelloOS' {
insmod part_msdos
insmod ext2
set root='hd0,msdos1' #我们的硬盘只有一个分区所以是'hd0,msdos1'
multiboot2 /boot/HelloOS.eki #加载boot目录下的HelloOS.eki文件
boot #引导启动
}
set timeout_style=menu
if [ "${timeout}" = 0 ]; then
  set timeout=10 #等待10秒钟自动启动
fi
EOF

# step4：用VirtualBox的工具将文件格式转成 VDI
VBoxManage convertfromraw ${base_dir}/hd.img --format VDI ${base_dir}/hd.vdi

# step4：安装虚拟硬盘
#   4.1 SATA的硬盘其控制器是intelAHCI，其中 HelloOS 是虚拟机的名称
VBoxManage storagectl HelloOS --name "SATA" --add sata --controller IntelAhci --portcount 1
#   4.2 删除虚拟硬盘UUID并重新分配
VBoxManage closemedium disk ${base_dir}/hd.vdi
#   4.3 将虚拟硬盘挂到虚拟机的硬盘控制器，其中 HelloOS 是虚拟机的名称
VBoxManage storageattach HelloOS --storagectl "SATA" --port 1 --device 0 --type hdd --medium ${base_dir}/hd.vdi
```

第四步报错：

```
Kernel driver not installed (rc=-1908)

The VirtualBox Linux kernel driver is either not loaded or not set up correctly. Please try setting it up again by executing

'/sbin/vboxconfig'

as root.

If your system has EFI Secure Boot enabled you may also need to sign the kernel modules (vboxdrv, vboxnetflt, vboxnetadp, vboxpci) before you can load them. Please see your Linux system's documentation for more information.

where: suplibOsInit what: 3 VERR_VM_DRIVER_NOT_INSTALLED (-1908) - The support driver is not installed. On linux, open returned ENOENT. 
```
