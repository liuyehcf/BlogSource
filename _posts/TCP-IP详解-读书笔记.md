---
title: TCP-IP详解-读书笔记
date: 2019-10-28 17:46:22
tags: 
- 摘录
categories: 
- Network
---

__阅读更多__

<!--more-->

# 1 概述

1. __网桥__是在__链路层__对网络进行互连，而__路由器__则是在__网络层__上对网络进行互连
1. `ICMP`是`IP`的附属协议，`IP`层用它来与其他主机或路由器交换错误报文和其他重要信息
1. 为`ICMP`、`IGMP`、`ARP`、`RARP`协议定位是比较棘手的，在不同的场景下可以位于不同的网络层级

# 2 链路层

1. 在`TCP/IP`协议簇中，链路层主要有三个目的
    * 为`IP`模块发送和接收`IP`数据报
    * 为`ARP`模块发送`ARP`请求和接收`ARP`应答
    * 为`RARP`发送`RARP`请求和接收`RARP`应答
1. 几个不同的标准集
    * `802.3`：整个`CSMA/CD`网络（Carrier Sense, Multiple Access with Collision Detection）
    * `802.4`：针对令牌总线网络
    * `802.5`：针对令牌环网络
1. `802.3`标准定义的帧和以太网的帧都有最小长度要求。`802.3`规定__数据部分__必须至少为38字节，而对于以太网，则要求最少要有46字节（这是为什么？）。为了保证这一点，必须在不足的空间插入填充字节
1. 大多数的产品都支持环回接口（Loopback Interface），以允许运行在同一台主机上的客户程序和服务器程序通过TCP/IP进行通信
1. 以太网和`802.3`对数据帧的长度都有一个限制，其最大值分别是1500和1492字节。链路层的这个特性称为`MTU`，最大传输单元。如果`IP`层有一个数据报要传，且数据报的长度比链路层的`MTU`还大，那么`IP`层就需要进行分片
1. 两台主机之间的通信如果经过多个网络，那么每个网络的链路层可能有不同的`MTU`，在这多个网络中，具有的最小`MTU`称作路径`MTU`
1. 两台主机之间的`MTU`不一定是个常数，它取决于当时所选择的路由，而选路不一定是对称的，因此路径`MTU`在两个方向上不一定是一致的
1. 网络地址划分
    * A类地址：0.0.0.0 -> 127.255.255.255
    * B类地址：128.0.0.0 -> 191.255.255.255
    * C类地址：192.0.0.0 -> 223.255.255.255
    * D类地址：224.0.0.0 -> 239.255.255.255
    * E类地址：240.0.0.0 -> 255.255.255.255

# 3 网际协议

1. `IP`提供不可靠、无连接的数据报传送服务
    * 不可靠：不保证`IP`数据报能成功到达目的地。`IP`仅能提供尽力而为的传输服务
    * 无连接：`IP`并不维护任何关于后续数据报的状态信息，每个数据报的处理是独立的，也就是说，`IP`数据报可以不按发送顺序接收（每个数据报的选路是独立的）
1. `IP`协议格式
    * 4位版本、4位首部长度、8位服务类型（TOS）、16位总长度（字节数）
    * 16位标志、3位标志、13位片偏移
    * 8位生存时间、8位协议、16位首部校验和
    * 32位源IP地址
    * 32位目的IP地址
    * 选项
    * 数据
1. 目前协议版本号是4，因此`IP`有时也称为`IPv4`
1. 首部长度指的是首部占`32bit字`的数目（32bit记为一份），由于这是一个4bit字段（0-15），因此首部最长为 `15*32bit=480bit=60Byte`
1. `TOS`字段包括一个3bit的优先权子字段（现已被忽略）、4bit的`TOS`子字段、1bit的未用字段（必须置0）。其中，4bit的`TOS`子字段分别代表
    * 最小时延（0x10）
    * 最大吞吐量（0x08）
    * 最高可靠性（0x04）
    * 最小费用（0x02）
    * 一般服务（0x00）
1. 总长度字段是指整个`IP`数据报的长度，以字节为单位（区别于首部长度，首部长度的单位是32bit，也就是4字节），由于该字段长度为16bit，所以`IP`数据报最长可达65535字节
1. `TTL`（time-to-live）生存时间字段设置了数据报可以经过的最多路由器数，`TTL`的初始值由源主机设置（通常为32或64），一旦经过一个处理它的路由器，他的值就会减去1。当该字段的值为0时，数据报就被丢弃，并发送`ICMP`报文通知源主机
1. 首部检验和字段是根据IP首部计算的检验和码，他不对首部后面的数据进行计算。`ICMP`、`IGMP`、`UDP`和`TCP`在它们各自的首部中均含有同时覆盖首部和数据的检验和码
1. 最后一个字段是任选项，是数据报中的一个可变长的可选信息，这些选项定义如下（这些选项很少使用，并非所有主机和路由器都支持，且选项都是以32bit作为界限，在必要时需要插入0填充，这样就保证了`IP`首部始终是32bit的整数倍）
    * 安全和处理限制
    * 记录路径
    * 时间戳
    * 宽松的源站选路
    * 严格的源站选路
1. `IP`层既可以配置成路由器的功能，也可以配置成主机的功能。本质的区别在于主机从不把数据报从一个接口转发到另一个接口，而路由器则要转发数据报
1. 路由表包含如下信息
    * 目的`IP`地址，既可以是一个完整的主机地址，也可以是一个网络地址
    * 下一站路由器的`IP`地址，指一个在直接相连网络上的路由器
    * 标志，其中一个标志标明目的IP地址是网络地址还是主机地址，另一个标志指明下一站路由器是否为真正的下一站路由器还是一个直接相连的接口
    * 为数据报传输指定一个网络接口
1. `IP`路由器主要完成如下功能
    * 搜索路由表，寻找能与目的`IP`地址完全匹配的表目
    * 搜索路由表，寻找能与目的网络号相匹配的表目
    * 搜索路由表，寻找标为默认（default）的路由表
1. 现在所有的主机都要求支持子网编址，不是把IP地址看成由单纯的一个网络号和一个主机号组成，而是把主机号再分成一个子网号和一个主机号。这样做的原因是A类和B类地址为主机号分配了太多的空间，可分别容纳的主机数太多了
1. 通常把B类地址留给主机的16bit中的前8bit作为子网地址，后8bit作为主机号
1. 子网对外部路由器来说隐藏了内部网络组织，但是对子网内部的路由器来说是不透明的（与30个C类地址相比，用一个包含30个子网的B类地址的好处是可以减小路由表的规模）
1. 子网掩码用来确定多少bit用于子网号，多少bit用于主机号（网络号的划分是明确的，而子网的划分是不明确的），其中值为1的bit表示网络号和子网号，为0的bit用于主机号
1. 给定IP和子网掩码后，主机就可以确定IP数据报的目的地，根据IP可以确定网络号和子网号的分界线，根据子网掩码可以确定子网号和主机号的分界线
    * 本子网上的主机
    * 本网络中其他子网中的主机
    * 其他网络上的主机

# 4 ARP: 地址解析协议

1. 链路层如以太网或令牌环网都有自己的寻址机制（通常为48bit），这是使用链路层的任何网络都必须遵从的
    * 例如，一组使用`TCP/IP`协议的主机和另一组使用某种PC网络软件的主机可以共享相同的电缆
1. 当一台主机把以太网数据帧发送到位于同一局域网上的另一台主机时，是根据48bit的以太网地址来确定目的接口的。设备驱动程序从不检查`IP`数据报中的目的`IP`地址
1. 地址解析为这两种不同的地址形式提供映射：32bit的`IP`地址和数据链路层使用的任何类型的地址
    * ARP为IP地址到对应的硬件地址之间提供动态映射，动态是指这个过程是自动完成的，一般用户和管理员无需关心
1. __ARP背后有一个基本概念，那就是网络接口有一个硬件地址（一个48bit的值，标识不同的以太网或令牌环网接口）。在硬件层次上进行的数据帧交换必须有正确的接口地址。知道主机的IP并不能让内核发送一帧数据给主机。内核（如以太网驱动程序）必须知道目的端的硬件地址才能发送数据。ARP的功能是在32bit的IP地址和采用不同网络技术的硬件地址之间提供动态映射__
1. ARP高效运行的关键是由于每个主机上都有一个ARP高速缓存。这个高速缓存存放了最近Internet地址到硬件地址之间的映射记录。高速缓存中每一项的生存时间一般为20分钟
    * `arp -a`可以查看高速缓存中的内容
1. 对于一个`IP`数据报，如果目的主机在本网络上（如以太网、令牌环网或点对点链接的另一端），那么`IP`数据报可以直接发送到目的主机上。如果目的主机在一个远程网络上，那么就通过`IP`选路函数来确定位于本地网络上的下一站路由器地址，并让它转发`IP`数据报。这两种情况下，`IP`数据报都是被送到本地网络上的一台主机或路由器（假定是以太网）
    * `ARP`发送一份称为`ARP`请求的以太网数据帧给以太网上的每个主机。这个过程称作广播。`ARP`请求中包含目的主机的IP地址。该请求的意思是：如果你是这个IP地址的拥有者，请回答你的硬件地址
    * 目的主机的`ARP`层收到这份广播报文后，识别出这是发送端在询问它的IP地址，于是发送一个`ARP`应答，这个`ARP`应答包含IP地址及对应的硬件地址
    * 收到`ARP`应答后，使`ARP`进行请求-应答交换的IP数据报现在就可以传送了
    * 发送IP数据报道目的主机
1. 直到`ARP`应答返回时，`TCP`报文才会被发送，因此对不存在的主机发送`TCP`报文，在链路上是看不到任何`TCP`数据的，但是会触发`TCP`的重传机制
1. `ARP`代理：如果`ARP`请求是从一个网络的主机发往另一个网络的主机，那么连接这两个网络的路由器就可以回答该请求，这个过程称为`ARP`代理（`Proxy ARP`）
1. 免费ARP：是指主机发送ARP查找自己的IP地址，通常它发生在系统引导期间进行接口配置的时候
    * 一个主机可以通过它来确定另一个主机是否设置了相同的IP地址
    * 使其他主机高速缓存中旧的硬件地址进行相应的更新（当某个主机更换了网卡接口的时候）。当某个主机收到了某个IP地址的ARP请求，而且它已经在接受者的高速缓存中，那么就要用ARP请求中的发送端硬件地址对高速缓存中相应的内容进行更新

# 5 RARP: 逆地址解析协议

1. 具有本地磁盘的系统引导时，一般从磁盘上的配置文件中读取`IP`地址。但是无盘机，需要采用其他方法来获得`IP`地址，这种方式就是`RARP`
1. 网络上的每个系统都有唯一的硬件地址，然后发送一份`RARP`请求，请求某个主机响应该误判系统的`IP`地址

# 6 ICMP: Internet控制报文协议

# 7 TCP: 传输控制协议（初步）

__ARP和重传__

1. Automatic Repeat Request, ARQ: 自从重复请求，是差错处理的一种非常重要的方法
1. 一个直接处理分组丢失（和比特差错）的方法是重发分组直到它被正确接收。这需要一个方法来判断，如下：
    * 接收方是否已收到分组
    * 接收方收到的分组是否与之前发送方发送的一样
    * 接收方给发送方发信号以确认自己已经接收到一个分组，这种方法称为确认（acknowledgment），或ACK。当发送方接收到这个ACK，它再发送另一个分组，这个过程就这样继续，但是会出现一些有意思的问题
        1. 发送方对一个ACK应该等待多长时间？
        1. 如果ACK丢失了怎么办？
        1. 如果分组被接收到了，但是里面有错怎么办？
1. 接收方可能受到被传送分组的重复副本，这个问题要使用序列号（sequence number）来处理

__分组窗口和滑动窗口__

1. 分组窗口（window）：已被发送方注入但还没完成确认的分组的集合。这个窗口中的分组数量称为窗口大小（window size）
    * 术语窗口来自这样的想法：如果你把在一个通信对话中发送的所有分组排成长长的一行，但只能通过一个小孔来观察它们，你就只能看到它们的一个自己---通过一个窗口观看一样
1. 当分组窗口中最左边的分组已收到ACK之后，窗口左侧的边界便可向右移动一格；窗口原右侧边界之外的第一个分组可以进入发送状态，随机进入分组窗口中，于是窗口的右侧边界便可向右移动一格，这便形成了分组窗口的滑动

__变量窗口：流量控制和拥塞控制__

1. 流量控制：用于解决当接收方相对发送方处理速度太慢时产生的问题，具体手段就是强迫发送方慢下来
1. 基于速率（rate-based）流量控制：给发送方指定某个速率，同时确保数据永远不能超过这个速率发送。这种类型的流量控制最适合流应用程序，可被用于广播和组播发现
1. 基于窗口（window-based）流量控制：窗口大小是不固定的，而且允许随时间而变动
    * 必须有一种方法可以通知发送方使用多大的窗口，一般称为窗口通告（window advertisement）或者窗口更新（window update）
1. 拥塞控制：发送方减低速度以不至于压垮其与接收方之间的网络

__设置重传超时__

1. 发送方在重发一个分组之前应等待的时间量大概是下面时间的总和
    1. 发送分组所用的时间
    1. 接收方处理它和发送一个ACK所用的时间
    1. ACK返回到发送方所用的时间
    1. 以及发送方处理ACK所用的时间
    * 遗憾的是，上述这些时间没有一个是固定不变的，都是随着环境的变化而变化的
1. 一个更好的策略是让协议实现尝试去估计这个重传超时时间，这称为往返时间估计（round-trip-time estimation, RTT），这是一个统计过程。总的来说，选择一组RTT样本的样本均值作为真实的RTT是最有可能的，这个平均值很自然地会随着时间而改变，因为通信穿过的网络路径可能会改变
1. 把重传超时时间设置为RTT均值是不合理的，因为很有可能许多实际的RTT将会比较大，从而会导致不必要的重传

__TCP服务模型__

1. TCP和UDP使用相同的网络层（IPv4或IPv6），但是TCP给应用程序提供了一种与UDP完全不同的服务。__TCP提供了一种面向连接的（connection-oriented）、可靠的字节流服务__。
1. 面向连接的：是指使用TCP的两个应用程序必须在它们可能交换数据之前，通过相互联系来建立一个TCP连接、就好像拨打一个电话号码，等待另一方接听电话并说“喂”，然后再说“找谁”。__因此，TCP中不存在广播、组播这种概念__，这两个概念与连接是矛盾的
1. 字节流服务：__TCP不会自动插入记录标志或消息边界__。例如，发送方可能分两次先后写入10字节、20字节，但是接收方可能一次性读入30字节，也有可能分3次每次读入10字节

__TCP中的可靠性__

1. TCP提供一个字节流接口，TCP必须把一个发送应用程序的字节流转换成一组IP可以携带的分组。这被称为组包
