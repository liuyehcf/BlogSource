---
title: 操作系统安装
date: 2019-11-23 14:19:39
tags: 
- 原创
categories: 
- Operating System
---

__阅读更多__

<!--more-->

# 1 镜像站

## 1.1 [网易开源镜像站](http://mirrors.163.com)

以`CentOS-7.7.1908`为例，下载地址为：`http://mirrors.163.com/centos/7.7.1908/isos/x86_64/CentOS-7-x86_64-Minimal-1908.iso`

## 1.2 [centos镜像站](http://mirror.centos.org/)

以`CentOS-7.7.1908`为例，下载地址列表为：`http://isoredirect.centos.org/centos/7.7.1908/isos/x86_64/`

# 2 CentOS装机

__博主安装的是minimal版本__

1. 配网，修改`/etc/sysconfig/network-scripts/ifcfg-enp0s3`，将`ONBOOT`修改为`yes`，然后执行`systemctl restart network`
1. 安装网络工具包`yum install -y net-tools.x86_64`
1. 安装vim`yum install -y vim`

## 2.1 配置分区容量

默认情况下，CentOS会给根分区分配50G的容量，剩余容量则分配给home分区，我们可以通过一组命令简单得调整一下分区容量

__仍然保留两个分区，将大部分的容量都分配给根分区__

```sh
# 1/11: 备份home分区文件
tar cvf /tmp/home.tar /home

# 2/11: 安装 psmisc（fuser）
yum install -y psmisc

# 3/11: 杀死所有占用/home目录的进程
fuser -km /home/

# 4/11: 卸载/home文件系统
umount /home

# 5/11: 删除/home所在的lv
lvremove /dev/mapper/centos-home

# 6/11: 扩展/root所在的lv
lvextend -L +320G /dev/mapper/centos-root

# 7/11: 扩展/root文件系统
xfs_growfs /dev/mapper/centos-root

# 8/11: 创建一个1G的home LV，然后再将所有的空闲分区追加到home LV
lvcreate -L 1G -n /dev/mapper/centos-home
lvextend -l +100%FREE /dev/mapper/centos-home

# 9/11: 创建home文件系统
mkfs.xfs  /dev/mapper/centos-home

# 10/11: 挂载home文件系统
mount /dev/mapper/centos-home

# 11/11: 恢复home文件系统
tar xvf /tmp/home.tar -C /home/
cd /home/home/
mv * ../
```

__只保留根分区，/home只作为根分区的一个目录__

```sh
# 1/9: 备份home分区文件
tar cvf /tmp/home.tar /home

# 2/9: 安装 psmisc（fuser）
yum install -y psmisc

# 3/9: 杀死所有占用/home目录的进程
fuser -km /home/

# 4/9: 卸载/home文件系统
umount /home

# 5/9: 删除/home所在的lv
lvremove /dev/mapper/centos-home

# 6/9: 扩展/root所在的lv
lvextend -l +100%FREE /dev/mapper/centos-root

# 7/9: 扩展/root文件系统
xfs_growfs /dev/mapper/centos-root

# 8/9: 恢复home文件系统
tar -xvf /tmp/home.tar -C /

# 9/9: 删除home分区记录
vim /etc/fstab
```

## 2.2 添加硬盘以及扩容LVM

### 2.2.1 fdisk

```sh
[root@liuyehcf ~]$ fdisk -l
#-------------------------↓↓↓↓↓↓-------------------------
磁盘 /dev/sda：11.9 GB, 11913920512 字节，23269376 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x000b1653

   设备 Boot      Start         End      Blocks   Id  System
/dev/sda1   *        2048     2099199     1048576   83  Linux
/dev/sda2         2099200    23269375    10585088   8e  Linux LVM

磁盘 /dev/sdb：8589 MB, 8589934592 字节，16777216 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节

磁盘 /dev/mapper/centos-root：9642 MB, 9642704896 字节，18833408 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节

磁盘 /dev/mapper/centos-swap：1191 MB, 1191182336 字节，2326528 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
#-------------------------↑↑↑↑↑↑-------------------------

[root@liuyehcf ~]$ fdisk /dev/sdb
#-------------------------↓↓↓↓↓↓-------------------------
欢迎使用 fdisk (util-linux 2.23.2)。

更改将停留在内存中，直到您决定将更改写入磁盘。
使用写入命令前请三思。

Device does not contain a recognized partition table
使用磁盘标识符 0xdc61f516 创建新的 DOS 磁盘标签。
#-------------------------↑↑↑↑↑↑-------------------------

命令(输入 m 获取帮助)：m
#-------------------------↓↓↓↓↓↓-------------------------
命令操作
   a   toggle a bootable flag
   b   edit bsd disklabel
   c   toggle the dos compatibility flag
   d   delete a partition
   g   create a new empty GPT partition table
   G   create an IRIX (SGI) partition table
   l   list known partition types
   m   print this menu
   n   add a new partition
   o   create a new empty DOS partition table
   p   print the partition table
   q   quit without saving changes
   s   create a new empty Sun disklabel
   t   change a partitions system id
   u   change display/entry units
   v   verify the partition table
   w   write table to disk and exit
   x   extra functionality (experts only)
#-------------------------↑↑↑↑↑↑-------------------------

命令(输入 m 获取帮助)：n
#-------------------------↓↓↓↓↓↓-------------------------
Partition type:
   p   primary (0 primary, 0 extended, 4 free)
   e   extended
#-------------------------↑↑↑↑↑↑-------------------------

Select (default p): p
分区号 (1-4，默认 1)：# 回车，默认值
起始 扇区 (2048-16777215，默认为 2048)：# 回车，默认值
#-------------------------↓↓↓↓↓↓-------------------------
将使用默认值 2048
#-------------------------↑↑↑↑↑↑-------------------------

Last 扇区, +扇区 or +size{K,M,G} (2048-16777215，默认为 16777215)：# 回车，默认值
#-------------------------↓↓↓↓↓↓-------------------------
将使用默认值 16777215
分区 1 已设置为 Linux 类型，大小设为 8 GiB
#-------------------------↑↑↑↑↑↑-------------------------

命令(输入 m 获取帮助)：t
#-------------------------↓↓↓↓↓↓-------------------------
已选择分区 1
#-------------------------↑↑↑↑↑↑-------------------------

Hex 代码(输入 L 列出所有代码)：L
#-------------------------↓↓↓↓↓↓-------------------------
 0  空              24  NEC DOS         81  Minix / 旧 Linu bf  Solaris
 1  FAT12           27  隐藏的 NTFS Win 82  Linux 交换 / So c1  DRDOS/sec (FAT-
 2  XENIX root      39  Plan 9          83  Linux           c4  DRDOS/sec (FAT-
 3  XENIX usr       3c  PartitionMagic  84  OS/2 隐藏的 C:  c6  DRDOS/sec (FAT-
 4  FAT16 <32M      40  Venix 80286     85  Linux 扩展      c7  Syrinx
 5  扩展            41  PPC PReP Boot   86  NTFS 卷集       da  非文件系统数据
 6  FAT16           42  SFS             87  NTFS 卷集       db  CP/M / CTOS / .
 7  HPFS/NTFS/exFAT 4d  QNX4.x          88  Linux 纯文本    de  Dell 工具
 8  AIX             4e  QNX4.x 第2部分  8e  Linux LVM       df  BootIt
 9  AIX 可启动      4f  QNX4.x 第3部分  93  Amoeba          e1  DOS 访问
 a  OS/2 启动管理器 50  OnTrack DM      94  Amoeba BBT      e3  DOS R/O
 b  W95 FAT32       51  OnTrack DM6 Aux 9f  BSD/OS          e4  SpeedStor
 c  W95 FAT32 (LBA) 52  CP/M            a0  IBM Thinkpad 休 eb  BeOS fs
 e  W95 FAT16 (LBA) 53  OnTrack DM6 Aux a5  FreeBSD         ee  GPT
 f  W95 扩展 (LBA)  54  OnTrackDM6      a6  OpenBSD         ef  EFI (FAT-12/16/
10  OPUS            55  EZ-Drive        a7  NeXTSTEP        f0  Linux/PA-RISC
11  隐藏的 FAT12    56  Golden Bow      a8  Darwin UFS      f1  SpeedStor
12  Compaq 诊断     5c  Priam Edisk     a9  NetBSD          f4  SpeedStor
14  隐藏的 FAT16 <3 61  SpeedStor       ab  Darwin 启动     f2  DOS 次要
16  隐藏的 FAT16    63  GNU HURD or Sys af  HFS / HFS+      fb  VMware VMFS
17  隐藏的 HPFS/NTF 64  Novell Netware  b7  BSDI fs         fc  VMware VMKCORE
18  AST 智能睡眠    65  Novell Netware  b8  BSDI swap       fd  Linux raid 自动
1b  隐藏的 W95 FAT3 70  DiskSecure 多启 bb  Boot Wizard 隐  fe  LANstep
1c  隐藏的 W95 FAT3 75  PC/IX           be  Solaris 启动    ff  BBT
1e  隐藏的 W95 FAT1 80  旧 Minix
#-------------------------↑↑↑↑↑↑-------------------------

Hex 代码(输入 L 列出所有代码)：8e
#-------------------------↓↓↓↓↓↓-------------------------
已将分区“Linux”的类型更改为“Linux LVM”
#-------------------------↑↑↑↑↑↑-------------------------

命令(输入 m 获取帮助)：w
#-------------------------↓↓↓↓↓↓-------------------------
The partition table has been altered!

Calling ioctl() to re-read partition table.
正在同步磁盘。
#-------------------------↑↑↑↑↑↑-------------------------

# 重新读取分区表
[root@liuyehcf ~]$ partprobe
[root@liuyehcf ~]$ fdisk -l
#-------------------------↓↓↓↓↓↓-------------------------
磁盘 /dev/sda：11.9 GB, 11913920512 字节，23269376 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x000b1653

   设备 Boot      Start         End      Blocks   Id  System
/dev/sda1   *        2048     2099199     1048576   83  Linux
/dev/sda2         2099200    23269375    10585088   8e  Linux LVM

磁盘 /dev/sdb：8589 MB, 8589934592 字节，16777216 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0xd1a484e2

   设备 Boot      Start         End      Blocks   Id  System
/dev/sdb1            2048    16777215     8387584   8e  Linux LVM

磁盘 /dev/mapper/centos-root：9642 MB, 9642704896 字节，18833408 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节

磁盘 /dev/mapper/centos-swap：1191 MB, 1191182336 字节，2326528 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
#-------------------------↑↑↑↑↑↑-------------------------

# 查看当前pv
[root@liuyehcf ~]$ pvdisplay
#-------------------------↓↓↓↓↓↓-------------------------
  --- Physical volume ---
  PV Name               /dev/sda2
  VG Name               centos
  PV Size               10.09 GiB / not usable 0
  Allocatable           yes
  PE Size               4.00 MiB
  Total PE              2584
  Free PE               1
  Allocated PE          2583
  PV UUID               R2tmMS-2sUX-cKKu-A3JN-frjv-11hs-zAIOt7
#-------------------------↑↑↑↑↑↑-------------------------

# 创建pv
[root@liuyehcf ~]$ pvcreate /dev/sdb1
#-------------------------↓↓↓↓↓↓-------------------------
  Physical volume "/dev/sdb1" successfully created.
#-------------------------↑↑↑↑↑↑-------------------------

# 再次查看pv
[root@liuyehcf ~]$ pvdisplay
#-------------------------↓↓↓↓↓↓-------------------------
  --- Physical volume ---
  PV Name               /dev/sda2
  VG Name               centos
  PV Size               10.09 GiB / not usable 0
  Allocatable           yes
  PE Size               4.00 MiB
  Total PE              2584
  Free PE               1
  Allocated PE          2583
  PV UUID               R2tmMS-2sUX-cKKu-A3JN-frjv-11hs-zAIOt7

  "/dev/sdb1" is a new physical volume of "<8.00 GiB"
  --- NEW Physical volume ---
  PV Name               /dev/sdb1
  VG Name
  PV Size               <8.00 GiB
  Allocatable           NO
  PE Size               0
  Total PE              0
  Free PE               0
  Allocated PE          0
  PV UUID               1KFdOD-iwWF-w7uy-vOwp-CxKh-X2nj-wlZXqL
#-------------------------↑↑↑↑↑↑-------------------------

# 查看卷组（volume group）
[root@liuyehcf ~]$ vgdisplay
#-------------------------↓↓↓↓↓↓-------------------------
  --- Volume group ---
  VG Name               centos
  System ID
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  3
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               2
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               10.09 GiB
  PE Size               4.00 MiB
  Total PE              2584
  Alloc PE / Size       2583 / <10.09 GiB
  Free  PE / Size       1 / 4.00 MiB
  VG UUID               dgAwma-p7HF-cIKR-07w9-smjU-twhD-cXGeWy
#-------------------------↑↑↑↑↑↑-------------------------

# 将新的pv加入 centos 卷组
[root@liuyehcf ~]$ vgextend centos /dev/sdb1
#-------------------------↓↓↓↓↓↓-------------------------
  Volume group "centos" successfully extended
#-------------------------↑↑↑↑↑↑-------------------------

# 再次查看卷组，可以看到free PE有8G
[root@liuyehcf ~]$ vgdisplay
#-------------------------↓↓↓↓↓↓-------------------------
  --- Volume group ---
  VG Name               centos
  System ID
  Format                lvm2
  Metadata Areas        2
  Metadata Sequence No  4
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               2
  Max PV                0
  Cur PV                2
  Act PV                2
  VG Size               <18.09 GiB
  PE Size               4.00 MiB
  Total PE              4631
  Alloc PE / Size       2583 / <10.09 GiB
  Free  PE / Size       2048 / 8.00 GiB
  VG UUID               dgAwma-p7HF-cIKR-07w9-smjU-twhD-cXGeWy
#-------------------------↑↑↑↑↑↑-------------------------

# 将当前卷组中剩余 P E添加到 centos-root 中
[root@liuyehcf ~]$ lvextend -l +100%FREE /dev/mapper/centos-root

# 扩展centos-root文件系统
[root@liuyehcf ~]$ xfs_growfs /dev/mapper/centos-root
#-------------------------↓↓↓↓↓↓-------------------------
meta-data=/dev/mapper/centos-root isize=512    agcount=4, agsize=588544 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=0 spinodes=0
data     =                       bsize=4096   blocks=2354176, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal               bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
data blocks changed from 2354176 to 4451328
#-------------------------↑↑↑↑↑↑-------------------------
```

### 2.2.2 parted

`fdisk`最多只能添加容量小于2TB的硬盘，当需要添加大于2TB容量的硬盘时，需要使用`parted`

```sh
[root@liuyehcf ~]$ fdisk -l
#-------------------------↓↓↓↓↓↓-------------------------
磁盘 /dev/sda：11.9 GB, 11913920512 字节，23269376 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
磁盘标签类型：dos
磁盘标识符：0x000b1653

   设备 Boot      Start         End      Blocks   Id  System
/dev/sda1   *        2048     2099199     1048576   83  Linux
/dev/sda2         2099200    23269375    10585088   8e  Linux LVM

磁盘 /dev/sdb：8589 MB, 8589934592 字节，16777216 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节

磁盘 /dev/mapper/centos-root：9642 MB, 9642704896 字节，18833408 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节

磁盘 /dev/mapper/centos-swap：1191 MB, 1191182336 字节，2326528 个扇区
Units = 扇区 of 1 * 512 = 512 bytes
扇区大小(逻辑/物理)：512 字节 / 512 字节
I/O 大小(最小/最佳)：512 字节 / 512 字节
#-------------------------↑↑↑↑↑↑-------------------------

[root@liuyehcf ~]$ parted /dev/sdb
#-------------------------↓↓↓↓↓↓-------------------------
GNU Parted 3.1
使用 /dev/sdb
Welcome to GNU Parted! Type 'help' to view a list of commands.
#-------------------------↑↑↑↑↑↑-------------------------

(parted) help
#-------------------------↓↓↓↓↓↓-------------------------
  align-check TYPE N                        check partition N for TYPE(min|opt) alignment
  help [COMMAND]                           print general help, or help on COMMAND
  mklabel,mktable LABEL-TYPE               create a new disklabel (partition table)
  mkpart PART-TYPE [FS-TYPE] START END     make a partition
  name NUMBER NAME                         name partition NUMBER as NAME
  print [devices|free|list,all|NUMBER]     display the partition table, available devices, free space, all found partitions, or a particular partition
  quit                                     exit program
  rescue START END                         rescue a lost partition near START and END

  resizepart NUMBER END                    resize partition NUMBER
  rm NUMBER                                delete partition NUMBER
  select DEVICE                            choose the device to edit
  disk_set FLAG STATE                      change the FLAG on selected device
  disk_toggle [FLAG]                       toggle the state of FLAG on selected device
  set NUMBER FLAG STATE                    change the FLAG on partition NUMBER
  toggle [NUMBER [FLAG]]                   toggle the state of FLAG on partition NUMBER
  unit UNIT                                set the default unit to UNIT
  version                                  display the version number and copyright information of GNU Parted
#-------------------------↑↑↑↑↑↑-------------------------

(parted) mklabel gpt
(parted) unit MB
(parted) mkpart primary 0.00MB 8589.00MB
#-------------------------↓↓↓↓↓↓-------------------------
警告: The resulting partition is not properly aligned for best performance.
#-------------------------↑↑↑↑↑↑-------------------------
忽略/Ignore/放弃/Cancel? ignore

(parted) print
#-------------------------↓↓↓↓↓↓-------------------------
Model: ATA VBOX HARDDISK (scsi)
Disk /dev/sdb: 8590MB
Sector size (logical/physical): 512B/512B
Partition Table: gpt
Disk Flags:

Number  Start   End     Size    File system  Name     标志
 1      0.02MB  8589MB  8589MB               primary
#-------------------------↑↑↑↑↑↑-------------------------

(parted) quit
#-------------------------↓↓↓↓↓↓-------------------------
信息: You may need to update /etc/fstab.
#-------------------------↑↑↑↑↑↑-------------------------

# 磁盘格式化
[root@liuyehcf ~]$ mkfs.xfs /dev/sdb1
#-------------------------↓↓↓↓↓↓-------------------------
meta-data=/dev/sdb1              isize=512    agcount=4, agsize=524230 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=0, sparse=0
data     =                       bsize=4096   blocks=2096919, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal log           bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
#-------------------------↑↑↑↑↑↑-------------------------

# 查看物理卷
[root@liuyehcf ~]$ pvdisplay
#-------------------------↓↓↓↓↓↓-------------------------
  --- Physical volume ---
  PV Name               /dev/sda2
  VG Name               centos
  PV Size               10.09 GiB / not usable 0
  Allocatable           yes
  PE Size               4.00 MiB
  Total PE              2584
  Free PE               1
  Allocated PE          2583
  PV UUID               R2tmMS-2sUX-cKKu-A3JN-frjv-11hs-zAIOt7
#-------------------------↑↑↑↑↑↑-------------------------

# 创建物理卷
[root@liuyehcf ~]$ pvcreate /dev/sdb1
WARNING: xfs signature detected on /dev/sdb1 at offset 0. Wipe it? [y/n]: y
#-------------------------↓↓↓↓↓↓-------------------------
  Wiping xfs signature on /dev/sdb1.
  Physical volume "/dev/sdb1" successfully created.
#-------------------------↑↑↑↑↑↑-------------------------

# 查看物理卷，发现多了个 /dev/sdb1
[root@liuyehcf ~]$ pvdisplay
#-------------------------↓↓↓↓↓↓-------------------------
  --- Physical volume ---
  PV Name               /dev/sda2
  VG Name               centos
  PV Size               10.09 GiB / not usable 0
  Allocatable           yes
  PE Size               4.00 MiB
  Total PE              2584
  Free PE               1
  Allocated PE          2583
  PV UUID               R2tmMS-2sUX-cKKu-A3JN-frjv-11hs-zAIOt7

  "/dev/sdb1" is a new physical volume of "<8.00 GiB"
  --- NEW Physical volume ---
  PV Name               /dev/sdb1
  VG Name
  PV Size               <8.00 GiB
  Allocatable           NO
  PE Size               0
  Total PE              0
  Free PE               0
  Allocated PE          0
  PV UUID               cBcZHS-RiCM-OElU-1l7g-fQfT-sazO-yd0eg3
#-------------------------↑↑↑↑↑↑-------------------------

# 查看卷组
[root@liuyehcf ~]$ vgdisplay
#-------------------------↓↓↓↓↓↓-------------------------
  --- Volume group ---
  VG Name               centos
  System ID
  Format                lvm2
  Metadata Areas        1
  Metadata Sequence No  3
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               2
  Max PV                0
  Cur PV                1
  Act PV                1
  VG Size               10.09 GiB
  PE Size               4.00 MiB
  Total PE              2584
  Alloc PE / Size       2583 / <10.09 GiB
  Free  PE / Size       1 / 4.00 MiB
  VG UUID               dgAwma-p7HF-cIKR-07w9-smjU-twhD-cXGeWy
  #-------------------------↑↑↑↑↑↑-------------------------

# 将新的pv加入 centos 卷组
[root@liuyehcf ~]$ vgextend centos /dev/sdb1
#-------------------------↓↓↓↓↓↓-------------------------
  Volume group "centos" successfully extended
#-------------------------↑↑↑↑↑↑-------------------------

# 再次查看卷组，发现Free PE有8个G
[root@liuyehcf ~]$ vgdisplay
#-------------------------↓↓↓↓↓↓-------------------------
  --- Volume group ---
  VG Name               centos
  System ID
  Format                lvm2
  Metadata Areas        2
  Metadata Sequence No  4
  VG Access             read/write
  VG Status             resizable
  MAX LV                0
  Cur LV                2
  Open LV               2
  Max PV                0
  Cur PV                2
  Act PV                2
  VG Size               <18.09 GiB
  PE Size               4.00 MiB
  Total PE              4631
  Alloc PE / Size       2583 / <10.09 GiB
  Free  PE / Size       2048 / 8.00 GiB
  VG UUID               dgAwma-p7HF-cIKR-07w9-smjU-twhD-cXGeWy
#-------------------------↑↑↑↑↑↑-------------------------

# 将当前卷组中剩余 P E添加到 centos-root 中
[root@liuyehcf ~]$ lvextend -l +100%FREE /dev/mapper/centos-root
#-------------------------↓↓↓↓↓↓-------------------------
  Size of logical volume centos/root changed from 8.98 GiB (2299 extents) to 16.98 GiB (4347 extents).
  Logical volume centos/root successfully resized.
#-------------------------↑↑↑↑↑↑-------------------------

# 扩展centos-root文件系统
[root@liuyehcf ~]$ xfs_growfs /dev/mapper/centos-root
#-------------------------↓↓↓↓↓↓-------------------------
meta-data=/dev/mapper/centos-root isize=512    agcount=4, agsize=588544 blks
         =                       sectsz=512   attr=2, projid32bit=1
         =                       crc=1        finobt=0 spinodes=0
data     =                       bsize=4096   blocks=2354176, imaxpct=25
         =                       sunit=0      swidth=0 blks
naming   =version 2              bsize=4096   ascii-ci=0 ftype=1
log      =internal               bsize=4096   blocks=2560, version=2
         =                       sectsz=512   sunit=0 blks, lazy-count=1
realtime =none                   extsz=4096   blocks=0, rtextents=0
data blocks changed from 2354176 to 4451328
#-------------------------↑↑↑↑↑↑-------------------------
```

## 2.3 修复因断电导致磁盘inode损坏

__步骤__

1. 进入`emergency`模式
    * 在CentOS的boot菜单下按`e`，并编辑grub命令，在`LANG=en_US.UTF-8`之后追加`systemd.unit=emergency.target`，按`Ctrl+x`即可进入`emergency`模式
    * ![fig1](/images/操作系统安装/fig1.png)
1. 找到`Linux LVM`的根分区地址和设备
1. `cat /etc/fstab`确定根分区文件系统类型，通常为`ext4`或`xfs`
    * 若文件系统为`ext4`，运行`fsck -f`，例如`fsck -f /dev/mapper/centos-root`
    * 若文件系统为`xfs`，运行`xfs_repair -v /dev/mapper/centos-root`
        * 针对根分区已加载的情况下，可以执行`xfs_repair -d /dev/mapper/centos-root`尝试修复
        * 如果修复失败，可以添加参数`-L`进行修复，但是这样会丢失一部分文件系统日志，不建议一开始就尝试，可以作为最终解决方案

## 2.4 概念理解

1. 物理卷（physics volume）
    * 可以用`pvdisplay`查看逻辑卷
1. 卷组（volume group）
    * 可以用`vgdisplay`查看逻辑卷
1. 逻辑卷（logical volume）
    * 可以用`lvdisplay`查看逻辑卷
    * 上面出现的`/dev/centos/root`就是逻辑卷，而`/dev/mapper/centos-root`其实是一个逻辑磁盘
        * `/dev/mapper/centos-root`其实是个链接文件，链接到了`/dev/dm-0`，在你的电脑上可能不是`0`
        * `dmsetup info /dev/dm-0`可以查看`/dev/dm-0`的信息
        * `sudo lvdisplay|awk  '/LV Name/{n=$3} /Block device/{d=$3; sub(".*:","dm-",d); print d,n;}'`可以查看映射关系

# 3 CentOS自定义发行版iso镜像制作

## 3.1 初次尝试制作镜像

在本小结，我们将iso镜像文件解压，然后将解压之后的文件原封不动地打成iso镜像，目的是为了熟悉镜像制作的各个命令行工具

为了减少环境因素对镜像制作造成的影响，这里使用docker容器来进行打包，DockerFile如下，非常简单，基础镜像为`centos:7.6.1810`，并用yum安装了镜像制作的相关工具

```Dockerfile
FROM centos:7.6.1810

WORKDIR /

RUN yum install -y createrepo genisoimage syslinux-utils syslinux isomd5sum
```

接下来制作docker镜像

```sh
docker build -t create-iso-env:1.0.0 .
```

我们先研究一下官方的iso文件的结构，我下载的是`CentOS-7-x86_64-Minimal-1908.iso`，解压之后，目录结构如下（rpm包太多了，这里省略掉）

```
.
├── CentOS_BuildTag
├── EFI
│   ├── BOOT
│   │   ├── BOOTIA32.EFI
│   │   ├── BOOTX64.EFI
│   │   ├── TRANS.TBL
│   │   ├── fonts
│   │   │   ├── TRANS.TBL
│   │   │   └── unicode.pf2
│   │   ├── grub.cfg
│   │   ├── grubia32.efi
│   │   ├── grubx64.efi
│   │   ├── mmia32.efi
│   │   └── mmx64.efi
│   └── TRANS.TBL
├── EULA
├── GPL
├── LiveOS
│   ├── TRANS.TBL
│   └── squashfs.img
├── Packages
│   ├── GeoIP-1.5.0-14.el7.x86_64.rpm
│   ├── ...
│   └── zlib-1.2.7-18.el7.x86_64.rpm
├── RPM-GPG-KEY-CentOS-7
├── RPM-GPG-KEY-CentOS-Testing-7
├── TRANS.TBL
├── images
│   ├── TRANS.TBL
│   ├── efiboot.img
│   └── pxeboot
│       ├── TRANS.TBL
│       ├── initrd.img
│       └── vmlinuz
├── isolinux
│   ├── TRANS.TBL
│   ├── boot.cat
│   ├── boot.msg
│   ├── grub.conf
│   ├── initrd.img
│   ├── isolinux.bin
│   ├── isolinux.cfg
│   ├── memtest
│   ├── splash.png
│   ├── vesamenu.c32
│   └── vmlinuz
└── repodata
    ├── 16890efb08ba2667b3cfd83c4d234d5fabea890e6ed2ade4d4d7adec9670a9a5
    ├── 3654075e05ea799f20d35bc250759378ae24bbba929973efc9ab809b182a4c7c
    ├── 4af1fba0c1d6175b7e3c862b4bddfef93fffb84c37f7d5f18cfbff08abc47f8a
    ├── 521f322f05f9802f2438d8bb7d97558c64ff3ff74c03322d77787ade9152d8bb
    ├── 5a783c36d40a53713ff101426228dc9d0459e7246e1a1bdb530c97a478784d53
    ├── 7b2c05dfb46ff4a36822aa3c9d3484a7bdd3f356f4638ddf239f89d5f8f9bca1
    ├── 83b61f9495b5f728989499479e928e09851199a8846ea37ce008a3eb79ad84a0
    ├── 848a2b870c34dbf5186e3a09d6e0105959117b6864a5715df3cf3a40d8b04e60
    ├── TRANS.TBL
    ├── d4de4d1e2d2597c177bb095da8f1ad794d69f76e8ac7ab1ba6340fdd0969e936
    ├── fa095a8e52d5d2f81f1947b3a25f10608250d40b14b579469a93c28fced5d60e
    ├── repomd.xml
    └── repomd.xml.asc
```

运行docker。这里挂载了3个目录

1. `/Users/hechenfeng/Work/Resource/install-package/CentOS-7-x86_64-Minimal-1908`：该目录是我解压iso文件之后得到的目录，对应于容器中的`/source`目录
1. `/Users/hechenfeng/Desktop/workspace`：该目录是镜像制作的工作目录，对应于容器中的`/workspace`目录
1. `/Users/hechenfeng/Desktop/iso`：该目录用于放置生成的iso文件，对应于容器中的`/target`目录

```sh
docker run -v /Users/hechenfeng/Work/Resource/install-package/CentOS-7-x86_64-Minimal-1908:/source -v /Users/hechenfeng/Desktop/workspace:/workspace -v /Users/hechenfeng/Desktop/iso:/target -it create-iso-env:1.0.0 bash
```

__以下命令均在容器中执行__

第一步：将`/source`目录中的内容，拷贝到`/workspace`目录中

```sh
rm -rf /workspace/*
cp -a /source/* /workspace/
```

第二步：根据`comps.xml`制作本地repo。这里有一个坑，官方的CentOS镜像解压后，是不存在`comps.xml`这个文件的，这个文件存在于`repodata`目录中（容器中的路径为`/workspace/repodata`），且名字是一个随机字符串。可以通过如下命令将该文件重命名且移动至上层目录，然后重新制作本地repo。此外，也可以从[CentOS的官方文档](http://mirror.centos.org/centos/7/os/x86_64/repodata/)中下载`comps.xml`文件

```sh
# 找到该comps.xml文件
file=$(grep -r '<id>anaconda-tools</id>' /workspace/repodata | awk -F ':' '{print $1}')

echo "file: '${file}'"

# 移动至上层目录
mv ${file} /workspace/comps.xml

# 清理原有的repo
rm -rf /workspace/repodata/

# 重新制作repo
createrepo -g /workspace/comps.xml /workspace
```

第四步：接下来，就可以制作镜像了，详细流程可以参考[RedHat文档](https://www.redhat.com/en/blog/building-custom-boot-iso-red-hat-virtualization-hypervisor?source=searchresultlisting)

```sh
fileName=/target/my-centos-1.iso
label="CentOS 7 x86_64"

genisoimage \
       -V "${label}" \
       -A "${label}" \
       -o ${fileName} \
       -joliet-long \
       -b isolinux/isolinux.bin \
       -c isolinux/boot.cat \
       -no-emul-boot \
       -boot-load-size 4 \
       -boot-info-table \
       -eltorito-alt-boot -e images/efiboot.img \
       -no-emul-boot \
       -R -J -v -T \
       /workspace/

isohybrid --uefi ${fileName}

implantisomd5 ${fileName}
```

## 3.2 修改发行版信息

我们重新运行一个容器来制作镜像

```sh
docker run -v /Users/hechenfeng/Work/Resource/install-package/CentOS-7-x86_64-Minimal-1908:/source -v /Users/hechenfeng/Desktop/workspace:/workspace -v /Users/hechenfeng/Desktop/iso:/target -it create-iso-env:1.0.0 bash
```

__以下命令均在容器中执行__

第一步：将`/source`目录中的内容，拷贝到`/workspace`目录中

```sh
rm -rf /workspace/*
cp -a /source/* /workspace/
```

第二步：修改标签以及标题

```sh
originalLabelEscape="CentOS\\\\x207\\\\x20x86_64"
originalLabel="CentOS 7 x86_64"
originalTitle="CentOS 7"

newLabelEscape="LABEL_LIUYEHCF"
newLabel="LABEL_LIUYEHCF"
newTitle="TITLE_LIUYEHCF"

# 先找出需要修改的文件列表
files=$(find /workspace -name '*.cfg' -o -name '*.conf' -o -name '*.cfgn')

# 先判断一下哪些需要进行过滤
for file in ${files}
do
    totalNum=0
    num=$(cat ${file} | sed -n "s/${originalLabelEscape}/${newLabelEscape}/gp" | wc -l)
    totalNum=$[ ${totalNum} + ${num} ]
    num=$(cat ${file} | sed -n "s/${originalLabel}/${newLabel}/gp" | wc -l)
    totalNum=$[ ${totalNum} + ${num} ]
    num=$(cat ${file} | sed -n "s/${originalTitle}/${newTitle}/gp" | wc -l)
    totalNum=$[ ${totalNum} + ${num} ]

    if [ ${totalNum} -gt 0 ]; then
        cp -a ${file} ${file}.bak

        sed -i "s/${originalLabelEscape}/${newLabelEscape}/g" ${file}
        sed -i "s/${originalLabel}/${newLabel}/g" ${file}
        sed -i "s/${originalTitle}/${newTitle}/g" ${file}

        echo -e "\n文件 '${file}'，修改前后差异如下"
        diff ${file}.bak ${file}

        echo -e "\n"
    fi
done
```

第三步：根据`comps.xml`制作本地repo

```sh
# 找到该comps.xml文件
file=$(grep -r '<id>anaconda-tools</id>' /workspace/repodata | awk -F ':' '{print $1}')

echo "file: '${file}'"

# 移动至上层目录
mv ${file} /workspace/comps.xml

# 清理原有的repo
rm -rf /workspace/repodata/

# 重新制作repo
createrepo -g /workspace/comps.xml /workspace
```

第四步：制作镜像

```sh
fileName=/target/my-centos-2.iso
label="LABEL_LIUYEHCF"

genisoimage \
       -V "${label}" \
       -A "${label}" \
       -o ${fileName} \
       -joliet-long \
       -b isolinux/isolinux.bin \
       -c isolinux/boot.cat \
       -no-emul-boot \
       -boot-load-size 4 \
       -boot-info-table \
       -eltorito-alt-boot -e images/efiboot.img \
       -no-emul-boot \
       -R -J -v -T \
       /workspace/

isohybrid --uefi ${fileName}

implantisomd5 ${fileName}
```

## 3.3 使用kickstart定制化安装流程

在正常装机完成之后，会有一个`/root/anaconda.ks`文件，其内容如下。我们的`kickstart`文件可以参考这个文件的内容来编写

```sh
#version=DEVEL
# System authorization information
auth --enableshadow --passalgo=sha512
# Use CDROM installation media
cdrom
# Use graphical install
graphical
# Run the Setup Agent on first boot
firstboot --enable
ignoredisk --only-use=sda
# Keyboard layouts
keyboard --vckeymap=us --xlayouts='us'
# System language
lang en_US.UTF-8

# Network information
network  --bootproto=dhcp --device=enp0s3 --onboot=off --ipv6=auto --no-activate
network  --bootproto=dhcp --device=enp0s8 --onboot=off --ipv6=auto
network  --hostname=localhost.localdomain

# Root password
rootpw --iscrypted $6$06oxYFWoYXYYJSk/$QFoFc4yAthMW1H/oQPsTJQtUjvd5O0pqynKe84N6HVDXTYxmn2ERpAoplp9aX88eYpShM/ARNrhU.vgC35HSO1
# System services
services --enabled="chronyd"
# System timezone
timezone America/New_York --isUtc
# System bootloader configuration
bootloader --append=" crashkernel=auto" --location=mbr --boot-drive=sda
autopart --type=lvm
# Partition clearing information
clearpart --all --initlabel --drives=sda

%packages
@^minimal
@core
chrony
kexec-tools

%end

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

%anaconda
pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
%end
```

我们重新运行一个容器来制作镜像

```sh
docker run -v /Users/hechenfeng/Work/Resource/install-package/CentOS-7-x86_64-Minimal-1908:/source -v /Users/hechenfeng/Desktop/workspace:/workspace -v /Users/hechenfeng/Desktop/iso:/target -it create-iso-env:1.0.0 bash
```

__以下命令均在容器中执行__

第一步：将`/source`目录中的内容，拷贝到`/workspace`目录中

```sh
rm -rf /workspace/*
cp -a /source/* /workspace/
```

第二步：编写`kickstart`文件，路径为`/workspace/liuyehcf.ks`，相比于上面展示的`/root/anaconda.ks`，改造点如下

* 禁用了root账号
* 增加了一个用户`liuyehcf`，其密码为`!Abcd1234`，密文可以通过命令`python3 -c 'import crypt; print(crypt.crypt("!Abcd1234", crypt.mksalt()))'`获取
* 禁用自动分区，注释掉`autopart --type=lvm`
* 避免安装完成重启时，仍然从iso启动，增加`reboot --eject`
* 第一个post，将iso中的`EFI`目录拷贝到操作系统中的`/EFI`目录（可以是任意文件或目录，这里用`EFI`来做示范）
    * __需要指定`--nochroot`参数__
    * __`/run/install/repo`：iso的挂载点__
    * __`/mnt/sysimage`：操作系统根目录的挂载点__
* 第二个post，执行一些定制化的步骤，这里是写了一个文件，`/root/greet`

```sh
cat > /workspace/liuyehcf.ks << 'EOF'
#version=DEVEL
# System authorization information
auth --enableshadow --passalgo=sha512
# Use CDROM installation media
cdrom
# Use graphical install
graphical
# Run the Setup Agent on first boot
firstboot --enable
ignoredisk --only-use=sda
# Keyboard layouts
keyboard --vckeymap=us --xlayouts='us'
# System language
lang en_US.UTF-8

# Network information
network  --bootproto=dhcp --device=enp0s3 --onboot=off --ipv6=auto --no-activate
network  --bootproto=dhcp --device=enp0s8 --onboot=off --ipv6=auto
network  --hostname=localhost.localdomain

# Root password
rootpw --lock
# Custom user password
user --groups=wheel --name=liuyehcf --password=$6$jWXzp2aDfZJ96SJt$/F.3oD7m6ymvcKtN77Lmkp3ckLMAExxL1Fh64vk4XluEbEszSti85vRCvun6dAvf0Kfs81tFYkBP2tSQH3HdY. --iscrypted --gecos="LiuyeHcf" --shell=/usr/bin/bash
# System services
services --enabled="chronyd"
# System timezone
timezone America/New_York --isUtc
# System bootloader configuration
bootloader --append=" crashkernel=auto" --location=mbr --boot-drive=sda
#autopart --type=lvm
# Partition clearing information
clearpart --all --initlabel --drives=sda

# Avoid loading from iso on restart
reboot --eject

%packages
@^minimal
@core
chrony
kexec-tools

%end

%addon com_redhat_kdump --enable --reserve-mb='auto'

%end

%anaconda
pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
%end

# Copy the files in iso to the operating system
%post --nochroot
#!/bin/sh

mkdir -p /mnt/sysimage/EFI
cp -a /run/install/repo/EFI/* /mnt/sysimage/EFI/

%end

# Do something special
%post --interpreter=/usr/bin/bash --log=/root/ks-post.log --erroronfail
#!/bin/sh

echo "hello world" > /root/greet

%end
EOF
```

第三步：修改配置文件，关联这个`kickstart`文件（`/workspace/liuyehcf.ks`）

```sh
# ks文件的路径，工作目录/workspace，对iso来说就是根目录
ksPath=/liuyehcf.ks
labelEscape="CentOS\\\\x207\\\\x20x86_64"
instStage2Content="inst.stage2=hd:LABEL="${labelEscape}
instKsContent="inst.ks=hd:LABEL="${labelEscape}:${ksPath}

# 先找出需要修改的文件列表
files=$(find /workspace -name '*.cfg' -o -name '*.conf' -o -name '*.cfgn')

# 先判断一下哪些需要进行过滤
for file in ${files}
do
    num=$(cat ${file} | sed -n "s|${instStage2Content}|${instStage2Content} ${instKsContent}|gp" | wc -l)

    if [ ${num} -gt 0 ]; then
        cp -a ${file} ${file}.bak

        sed -i "s|${instStage2Content}|${instStage2Content} ${instKsContent}|g" ${file}

        echo -e "\n文件 '${file}'，修改前后差异如下"
        diff ${file}.bak ${file}

        echo -e "\n"
    fi
done
```

第四步：根据`comps.xml`制作本地repo

```sh
# 找到该comps.xml文件
file=$(grep -r '<id>anaconda-tools</id>' /workspace/repodata | awk -F ':' '{print $1}')

echo "file: '${file}'"

# 移动至上层目录
mv ${file} /workspace/comps.xml

# 清理原有的repo
rm -rf /workspace/repodata/

# 重新制作repo
createrepo -g /workspace/comps.xml /workspace
```

第五步：制作镜像

```sh
fileName=/target/my-centos-3.iso
label="CentOS 7 x86_64"

genisoimage \
       -V "${label}" \
       -A "${label}" \
       -o ${fileName} \
       -joliet-long \
       -b isolinux/isolinux.bin \
       -c isolinux/boot.cat \
       -no-emul-boot \
       -boot-load-size 4 \
       -boot-info-table \
       -eltorito-alt-boot -e images/efiboot.img \
       -no-emul-boot \
       -R -J -v -T \
       /workspace/

isohybrid --uefi ${fileName}

implantisomd5 ${fileName}
```

__验证__

1. 装机的时候，只需要进行一步操作，磁盘分区，其他操作都是自动进行的
1. 用`liuyehcf/!Abcd1234`登录
1. 检查`/EFI`目录以及子文件子目录是否存在
1. 检查`root/greet`文件是否存在

## 3.4 其他

### 3.4.1 iso包含大文件（4G以上）

用`genisoimage`制作iso的时候，如果包含了超过4G的文件，那么需要加上参数`-allow-limited-size`。__但是，这样会造成一个问题：如果iso中的某些文件在kickstart中会拷贝到目标的操作系统当中，那么这些文件的执行权限会丢失__

如果包含了4G以上的文件，那就无法使用FAT32文件系统来制作U盘启动盘。__但是我们可以使用`split`以及`cat`命令来拆分以及重建大文件，如此一来就又可以使用FAT32文件系统了__

```sh
# 拆分
split -b 2048M bigfile bigfile-slice-

# 重建
cat bigfile-slice-* > rebuild-bigfile
```

# 4 核心概念

## 4.1 BIOS与UEFI

`BIOS（Basic Input Output System）`是基本输入输出系统。它是一组固化到计算机内主板上一个`ROM`芯片上的程序，保存着计算机最重要的基本输入输出的程序、开机后自检程序和系统自启动程序，它可从`CMOS`中读写系统设置的具体信息

`UEFI（Unified Extensible Firmware Interface）`是统一可扩展固件界面，用来定义操作系统与系统硬件之间的软件界面，作为BIOS的替代方案。可扩展固件接口负责加电自检（POST），联系操作系统以及提供连接作业系统与硬体的介面

__实际上PC的启动固件的引导流程从IBM PC机诞生第一天起，就没有本质改变过，无论传统BIOS还是UEFI，阳光之下没有什么新鲜的东西，启动本身无外乎三个步骤__

1. `Rom Stage`：在这个阶段没有内存，需要在`ROM`上运行代码。这时因为没有内存，没有C语言运行需要的栈空间，开始往往是汇编语言，直接在`ROM`空间上运行。在找到个临时空间（`Cache`空间用作`RAM`，`Cache As Ram, CAR`）后，C语言终于可以粉墨登场了，后期用C语言初始化内存和为这个目的需要做的一切服务
1. `Ram Stage`：在经过`ROM`阶段的困难情况后，我们终于有了可以大展拳脚的内存，很多额外需要大内存的东西可以开始运行了。在这时我们开始进行初始化芯片组、CPU、主板模块等等核心过程
1. `Find something to boot Stage`：终于要进入正题了，需要启动，我们找到启动设备。就要枚举设备，发现启动设备，并把启动设备之前需要依赖的节点统统打通。然后开始移交工作，Windows或者Linux的时代开始

传统BIOS尽管开始全部用汇编语言完成，但后期也部分引入了C语言，这些步骤完全是一样的。什么`MBR`分区啊，`UEFI`分区都是枝节问题，都是技术上可以做到的，没有什么是`UEFI`可以做，传统BIOS不可以做到的。__那既然有BIOS了，为什么还需要UEFI呢__

1. 传统`BIOS`来自于IBM，之后就进入战国时代，激烈的商战让接口统一成为了不可能做到的事，只有在面对微软这个大用户的时候，才勉强提供了`兼容`的基于软中断的接口。它封闭、神秘和充满各种不清不楚的预设和祖传代码，在调试`PCI`的`ROM`时要小心各种`ROM`之间互相踩，各种只有老师傅才知道的神奇`诀窍`。要写个驱动，让它在各个BIOS厂商那里都能跑，简直成为了一件不可能完成的任务
1. 由Intel推动，在一开始就将标准公开，拉上了微软这个PC界的霸主，强势统一了江湖。在近20年的深耕下，统一了固件启动阶段基础框架`Spec：PI Spec`与操作系统的接口`Spec：UEFI Spec`，并将抽象硬件的原语性`Spec: ACPI Spec`也拉入这个大家庭，都变成`UEFI Forum`的一份子
1. 现在只要符合`UEFI driver model`的驱动都可以在各个`BIOS`上运行，打通了各个`BIOS`厂商之间的栅栏；与此同时，符合`UEFI`标准的操作系统都可以流畅的在各种主板上运行，无论是`Windows`，还是`Linux`各种发行版，甚至是`Android`。实际上，PC生态圈的繁荣，和`UEFI`的推广和被广泛接受是分不开的。值得一提的是`UEFI`内核的大部分代码是由Intel的中国工程师开发的。在大家一次次电脑的正常运行后面，有他们辛勤工作背影。他们也为固件的开源和国产化做出了自己的贡献。代码已经全部开源一部分时间了

`CSM Configuration（Compatibility Support Module）`（兼容性支持模块）是`BIOS`上`Boot`选项里的一个下拉子项目（一些老的主板上没有此选项），与`Secure Boot`（安全启动，仅适用于使用UEFI启动的操作系统）是并列项。`CSM`开启使得可以支持`UEFI`启动和非`UEFI`启动

1. __若是需要启动传统`MBR`设备，则需开启`CSM`，关闭`Secure Boot`__
1. __若是需要启动`UEFI`设备，则需要关闭`CSM`，开启`Secure Boot`__

## 4.2 Grub

__`GRUB`的作用有以下几个：__

1. 加载操作系统的内核
1. 拥有一个可以让用户选择的的菜单，来选择到底启动哪个系统
1. 可以调用其他的启动引导程序，来实现多系统引导

按照启动流程，`BIOS`在自检完成后，会到第一个启动设备的`MBR`中读取`GRUB`。在`MBR`中用来放置启动引导程序的空间只有`446`Byte，那么`GRUB`可以放到这里吗？答案是空间不够，`GRUB`的功能非常强大，`MBR`空间是不够使用的。__那么`Linux`的解决办法是把`GRUB`的程序分成了三个阶段来执行__

1. __`Stage 1`：执行`GRUB`主程序__：第一阶段是用来执行`GRUB`主程序的，这个主程序必须放在启动区中（也就是`MBR`或者引导扇区中）。但是`MBR`太小了，所以只能安装`GRUB`的最小的主程序，而不能安装`GRUB`的相关配置文件。这个主程序主要是用来启动`Stage 1.5`和`Stage 2`的。
1. __`Stage 1.5`：识别不同的文件系统__：`Stage 2`比较大，只能放在文件系统中（分区），但是`Stage 1`不能识别不同的文件系统，所以不能直接加载`Stage 2`。这时需要先加载`Stage 1.5`，由`Stage 1.5`来加载不同文件系统中的`Stage 2`
    * 还有一个问题，难道`Stage 1.5`不是放在文件系统中的吗？如果是，那么`Stage 1`同样不能找到`Stage 1.5`。其实，`Stage 1.5`还真没有放在文件系统中，而是在安装`GRUB`时，直接安装到紧跟`MBR`之后的`32KB`的空间中，这段硬盘空间是空白无用的，而且是没有文件系统的，所以`Stage 1`可以直接读取`Stage 1.5`。读取了`Stage 1.5`就能识别不同的文件系统，才能加载`Stage 2`
1. __`Stage 2`：加载`GRUB`的配置文件__：`Stage 2`阶段主要就是加载`GRUB`的配置文件`/boot/grub/grub.conf`，然后根据配置文件中的定义，加载内核和虚拟文件系统。接下来内核就可以接管启动过程，继续自检与加载硬件模块了

# 5 Ubuntu装机

__博主安装的是server版本__

1. 设置root密码：`sudo passwd root`
1. 网卡配置文件为`/etc/network/interfaces`（无需修改）
1. 安装openssh：`apt-get install -y openssh-server`
1. 修改ssh配置文件`/etc/ssh/sshd_config`，将`PermitRootLogin`改为`yes`，重启sshd：`service ssh restart`

# 6 查看版本号

1. `lsb_release -a`：`yum install -y redhat-lsb`
1. `uname -r`：内核版本号
1. `/etc/*-release`，包括
    * `/etc/os-release`
    * `/etc/centos-release`：发行版
1. `/proc/version`

# 7 制作U盘启动盘

## 7.1 MacOS

```sh
# 先列出所有设备
diskutil list

# 找到u盘对应的设备，比如这里是 /dev/disk6，卸载它
diskutil unmountDisk /dev/disk6

# 烧制ISO文件到u盘
sudo dd if=<iso文件路径> of=/dev/disk6 bs=1m

# 弹出磁盘
diskutil eject /dev/disk6
```

## 7.2 Linux

```sh
# 先列出所有设备
fdisk -l

# 找到u盘对应的设备，比如这里是 /dev/sdb，卸载它
umount /dev/sdb

# 烧制ISO文件到u盘，通过status=progress显示实时进度
sudo dd bs=4M if=<iso文件路径> of=/dev/sdb status=progress oflag=sync
```

# 8 参考

* [CentOS 7 调整 home分区 扩大 root分区](https://my.oschina.net/jasonMrliu/blog/1604954)
* [手把手教你给 CentOS 7 添加硬盘及扩容(LVM)](https://aurthurxlc.github.io/Aurthur-2017/Centos-7-extend-lvm-volume.html)
* [Linux Creating a Partition Size Larger Than 2TB](https://www.cyberciti.biz/tips/fdisk-unable-to-create-partition-greater-2tb.html)
* [What is this dm-0 device?(/dev/mapper/centos-root以及/dev/dm-0)](https://superuser.com/questions/131519/what-is-this-dm-0-device)
* [使用isolinux制作liveUSB](https://blog.csdn.net/trochiluses/article/details/17585525)
* [CentOS Composer](https://docs.centos.org/en-US/centos/install-guide/Composer/)
* [按部就班---半自动化系统安装](https://zhuanlan.zhihu.com/p/45791653)
* [mkisofs制作镜像文件](https://www.cnblogs.com/klb561/p/9108712.html)
* [Building a Custom Boot ISO for Red Hat Virtualization Hypervisor](https://www.redhat.com/en/blog/building-custom-boot-iso-red-hat-virtualization-hypervisor?source=searchresultlisting)
* [How to use and edit comps.xml for package groups](https://fedoraproject.org/wiki/How_to_use_and_edit_comps.xml_for_package_groups)
* [定制自己的CentOS发行版](https://blog.51cto.com/716737/1302970)
* [CentOS官方comps.xml文件](http://mirror.centos.org/centos/7/os/x86_64/repodata/)
* [使用ISOLinux制作Linux系统安装盘](https://blog.csdn.net/liujixin8/article/details/4029887)
* [Kickstart 语法](https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/installation_guide/sect-kickstart-syntax)
* [Anaconda kickstart 官方文档](https://fedoraproject.org/wiki/Anaconda/Kickstart/zh-cn)
* [Anaconda kickstart and rootpw option](https://serverfault.com/questions/588532/anaconda-kickstart-and-rootpw-option)
* [Kickstart详解(转载)](https://blog.csdn.net/u010039418/article/details/79984341)
* [UEFI 引导与 BIOS 引导在原理上有什么区别？](https://www.zhihu.com/question/21672895)
* [How to make Windows 7 USB flash install media from Linux?](https://serverfault.com/questions/6714/how-to-make-windows-7-usb-flash-install-media-from-linux)
* [详解uefi、legacy以及U盘格式对系统安装的影响](https://zhuanlan.zhihu.com/p/91131208)
* [MBR与GPT](https://zhuanlan.zhihu.com/p/26098509)
* [聊聊BIOS、UEFI、MBR、GPT、GRUB](https://segmentfault.com/a/1190000020850901)
* [Linux启动引导程序（GRUB）加载内核的过程](https://blog.csdn.net/u010783226/article/details/106070429)
* [CentOS/RHEL 7 LVM Partitioning in Kickstart?](https://serverfault.com/questions/826006/centos-rhel-7-lvm-partitioning-in-kickstart)
* [grub2详解(翻译和整理官方手册)](https://www.cnblogs.com/f-ck-need-u/archive/2017/06/29/7094693.html)
* [What exactly is GRUB?](https://askubuntu.com/questions/347203/what-exactly-is-grub)
* [你知道计算机启动过程吗？](https://zhuanlan.zhihu.com/p/60751152)
* [UEFI启动和Bios（Legacy）启动的区别](https://blog.csdn.net/zhangxiangweide/article/details/95342334)
* [Download all dependencies with yumdownloader, even if already installed?](https://unix.stackexchange.com/questions/50642/download-all-dependencies-with-yumdownloader-even-if-already-installed)
* [GRUB 官方文档(简体中文)](https://wiki.archlinux.org/index.php/GRUB_(%E7%AE%80%E4%BD%93%E4%B8%AD%E6%96%87))
* [GRUB2配置文件"grub.cfg"详解(GRUB2实战手册)](http://www.jinbuguo.com/linux/grub.cfg.html)