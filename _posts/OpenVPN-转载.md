---
title: OpenVPN-转载
date: 2019-08-25 20:26:35
tags: 
- 摘录
categories: 
- Network
- VPN
---

__阅读更多__

[本文出处](https://juejin.im/post/5c11be4bf265da611510a8f6)

<!--more-->

# 1 基本理论篇

## 1.1 VPN 简介

### 1.1.1 OpenVPN 简介

`VPN`直译就是虚拟专用通道，是提供给企业之间或者个人与公司之间__安全数据传输__的隧道，`OpenVPN`无疑是`Linux`下开源`VPN`的先锋，提供了良好的性能和友好的用户`GUI`。

`OpenVPN`是一个基于`OpenSSL`库的应用层`VPN`实现。和传统`VPN`相比，它的优点是简单易用。

`OpenVPN`允许参与建立`VPN`的单点使用共享金钥，电子证书，或者用户名/密码来进行身份验证。它大量使用了`OpenSSL`加密库中的`SSLv3/TLSv1`协议函式库。`OpenVPN`能在`Solaris`、`Linux`、`OpenBSD`、`FreeBSD`、`NetBSD`、`Mac OS X`与`Windows`上运行，并包含了许多安全性的功能。它并不是一个基于`Web`的`VPN`软件，也不与`IPSec`及其他`VPN`软件包兼容。

虚拟私有网络（VPN）隧道是通过`Internet`隧道技术将两个不同地理位置的网络安全的连接起来的技术。当两个网络是使用私有`IP`地址的私有局域网络时，它们之间是不能相互访问的，这时使用隧道技术就可以使得两个子网内的主机进行通讯。例如，`VPN`隧道技术经常被用于大型机构中不同办公区域子网的连接。有时，使用`VPN`隧道仅仅是因为它很安全。服务提供商与公司会使用这样一种方式架设网络，他们将重要的服务器（如，数据库，VoIP，银行服务器）放置到一个子网内，仅仅让有权限的用户通过`VPN`隧道进行访问。如果需要搭建一个安全的`VPN`隧道，通常会选用__`IPSec`__，因为`IPSec VPN`隧道被多重安全层所保护。

`VPN`(虚拟专用网)发展至今已经不在是一个单纯的经过加密的访问隧道了，它已经融合了__访问控制、传输管理、加密、路由选择、可用性管理__等多种功能，并在全球的信息安全体系中发挥着重要的作用。也在网络上，有关各种`VPN`协议优缺点的比较是仁者见仁，智者见智，很多技术人员由于出于使用目的考虑，包括访问控制、安全和用户简单易用，灵活扩展等各方面，权衡利弊，难以取舍；尤其在`VOIP`语音环境中，网络安全显得尤为重要，因此现在越来越多的网络电话和语音网关支持`VPN`协议。

### 1.1.2 VPN 分类

#### 1.1.2.1 PPTP

![1-1-2-1](/images/OpenVPN-转载/1-1-2-1)

__点对点隧道协议(`PPTP`)__是由包括微软和`3Com`等公司组成的`PPTP`论坛开发的一种点对点隧道协，基于拨号使用的`PPP`协议使用`PAP`或`CHAP`之类的加密算法，或者使用`Microsoft`的点对点加密算法`MPPE`。其通过跨越基于`TCP/IP`的数据网络创建`VPN`实现了从远程客户端到专用企业服务器之间数据的安全传输。`PPTP`支持通过公共网络(例如`Internet`)建立按需的、多协议的、虚拟专用网络。`PPTP`允许加密`IP`通讯，然后在要跨越公司`IP `络或公共`IP`网络(如`Internet`)发送的`IP`头中对其进行封装。

#### 1.1.2.2 L2TP

![1-1-2-2](/images/OpenVPN-转载/1-1-2-2)

__第2层隧道协议(`L2TP`)__是`IETF`基于`L2F`(Cisco的第二层转发协议)开发的`PPTP`的后续版本。是一种工业标准`Internet`隧道协议，其可以为跨越面向数据包的媒体发送点到点协议(`PPP`)框架提供封装。`PPTP`和`L2TP`都使用`PPP`协议对数据进行封装，然后添加附加包头用于数据在互联网络上的传输。__`PPTP`只能在两端点间建立单一隧道。`L2TP`支持在两端点间使用多隧道，用户可以针对不同的服务质量创建不同的隧道。`L2TP`可以提供隧道验证，而`PPTP`则不支持隧道验证。但是当`L2TP`或`PPTP`与`IPSEC`共同使用时，可以由`IPSEC`提供隧道验证，不需要在第2层协议上验证隧道使用`L2TP`。`PPTP`要求互联网络为`IP`网络。__`L2TP`只要求隧道媒介提供面向数据包的点对点的连接，`L2TP`可以在`IP`(使用UDP)，帧中继永久虚拟电路(`PVCs`)，`X.25`虚拟电路(VCs)或`ATM VCs`网络上使用。

#### 1.1.2.3 IPSec

![1-1-2-3](/images/OpenVPN-转载/1-1-2-3)

`IPSec`的隧道是由__封装、路由与解封装__组成整个过程。隧道将原始数据包隐藏(或封装)在新的数据包内部。该新的数据包可能会有新的寻址与路由信息，从而使其能够通过网络传输。隧道与数据保密性结合使用时，在网络上窃听通讯的人将无法获取原始数据包数据(以及原始的源和目标)。封装的数据包到达目的地后，会删除封装，原始数据包头用于将数据包路由到最终目的地。

#### 1.1.2.4 SSLVPN

![1-1-2-4](/images/OpenVPN-转载/1-1-2-4)

`SSL`协议提供了数据__私密性、端点验证、信息完整性__等特性。`SSL`协议由许多子协议组成，其中两个主要的子协议是__握手协议和记录协议__。握手协议允许服务器和客户端在应用协议传输第一个数据字节以前，彼此确认，协商一种加密算法和密码钥匙。在数据传输期间，记录协议利用握手协议生成的密钥加密和解密后来交换的数据。

`SSL`独立于应用，因此任何一个应用程序都可以享受它的安全性而不必理会执行细节。`SSL`置身于网络结构体系的__传输层和应用层__之间。此外，`SSL`本身就被几乎所有的`Web`浏览器支持。这意味着客户端不需要为了支持`SSL`连接安装额外的软件。这两个特征就是`SSL`能应用于`VPN`的关键点。

#### 1.1.2.5 什么是 VPN 使用的隧道技术与隧道协议

`VPN`隧道所使用的公共网络可以是任何类型的通信网络。可以是`Internet`，也可以是企业内部网。为创建隧道，`VPN`的客户机和服务器必须使用相同的隧道协议，常用的隧道协议包括__点对点隧道协议`PPT`、第2层隧道协议`L2TP`和安全`IP`隧道模式`IPSec`。__

按照开放系统互联`OSI`参考模型划分，隧道技术可以分为以第2层隧道协议为基础的技术和以第3层隧道协议为基础的技术。第2层隧道协议对应`OSI`模型中的数据链路层，__使用帧作为数据传输单位__。`PPTP`和`L2TP`协议属于第2层隧道协议，都是将数据封装在点对点协议(PPP)的帧中通过`Internet`发送。第3层隧道协议对应OSI模型中的网络层，__使用包作为数据传输单位__。安全`IP`隧道模式`IPSec`属于第3层隧道协议，是将数据包封装在附加了`IP`包头的新数据包中通过`IP`网络传送。

__点对点隧道协议(`PPTP，Point-to-Point Tunneling Protocol`)将点对点协议(`PPP，Point-to-Point Protocol`)的数据帧封装进`IP`数据包中，通过`TCP／IP`网络进行传输__。`PPTP`可以对`IP`、`IPX`或`NetBEUI`数据进行加密传递。`PPTP`通过`PPTP`控制连接来创建、维护和终止一条隧道，并使用通用路由封装(`GRE，Generic Routing Encapsulation`)对`PPP`数据帧进行封装。封装前，`PPP`数据帧的有效载荷(有效传输数据)首先必须经过加密、压缩或是两者的混合处理。

__第2层隧道协议(`L2TP，Layer Two Tunneling Protocol`)是`PPTP`和第2层转发技术(`L2F，Layer Two Forward`)的结合__。第2层转发是`Cisco`公司提出的隧道技术。为了避免`PPTP`和`L2F`两种互不兼容的隧道技术在市场上彼此竞争给用户造成困惑和带来不便，`Internet`工程任务委员会`IETF`要求将两种技术结合在单一隧道协议中，并在该协议中综合`PPTP`和`L2F`两者的优点，由此产生了`L2TP`。`L2TP`协议将`PPP`数据帧封装后，可通过`TCP／IP`、`X.25`、帧中继或`ATM`等网络进行传送。`L2TP`可以对`IP`、`IPX`或`NetBEUI`数据进行加密传递。目前，仅定义了基于`TCP／IP`网络的`L2TP`。`L2TP`隧道协议既可用于`Internet`，也可用于企业内部网。

为了实现在专用或公共`IP`网络上的安全传输，__安全`IP`隧道模式`IPSec`使用安全方式封装和加密整个`IP`包。它首先对`IP`数据包进行加密，然后将密文数据包再次封装在明文`IP`包内，通过网络发送到接收端的`VPN`服务器。`VPN`服务器对收到的数据包进行处理，在去除明文`IP`包头，对内容进行解密之后，获得原始的`IP`数据包，再将其路由到目标网络的接收计算机。__

在这三种隧道协议中，__点对点隧道协议`PPTP`和第2层隧道协议`L2TP`的优点是对用微软公司操作系统的用户来说很方便学习，因为微软公司已把它们作为路由软件的一部分；缺点是`PPTP`和`L2TP`将不安全的`IP`数据包封装在安全的`IP`数据包内。`PPTP`和`L2TP`适用于远程访问虚拟专用网。安全`IP`隧道模式`IPSec`的优点是它定义了一套用于认证、保护私密和数据完整性的标准协议，缺点是微软公司对`IPSec`的支持不够。`IPSec`适用于可信的局域网之间的虚拟专用网，即企业内部网`VPN`应用。__

### 1.1.3 OpenVPN

典型的`SSL VPN`应用如`OpenVPN`，是一个比较好的开源软件。`PPTP`主要为那些经常外出移动或家庭办公的用户考虑；而`OpenVPN`主要是针对企业异地两地总分公司之间的VPN不间断按需连接，例如`ERP`在企业中的应用。

`OpenVPN`允许参与建立`VPN`的单点使用预设的私钥，第三方证书，或者用户名/密码来进行身份验证。它大量使用了`OpenSSL`加密库，以及`SSLv3/TLSv1`协议。`OpenVPN`能在`Linux、xBSD`、`Mac OS X`与`Windows 2000/XP`上运行。它并不是一个基于`Web`的`VPN`软件，也不与`IPsec`及其他`VPN`软件包兼容。

#### 1.1.3.1 隧道加密

`OpenVPN`使用`OpenSSL`库加密数据与控制信息：它使用了`OpesSSL`的加密以及验证功能，意味着，它能够使用任何`OpenSSL`支持的算法。它提供了可选的数据包`HMAC`功能以提高连接的安全性。此外，`OpenSSL`的硬件加速也能提高它的性能。

#### 1.1.3.2 验证

`OpenVPN`提供了多种身份验证方式，用以确认参与连接双方的身份，包括：__预享私钥，第三方证书以及用户名/密码组合__。预享密钥最为简单，但同时它只能用于建立点对点的`VPN`；基于`PKI`的第三方证书提供了最完善的功能，但是需要额外的精力去维护一个`PKI`证书体系。`OpenVPN2.0`后引入了用户名/口令组合的身份验证方式，它可以省略客户端证书，但是仍有一份服务器证书需要被用作加密。

#### 1.1.3.3 网络

__`OpenVPN`所有的通信都基于一个单一的`IP`端口，默认且推荐使用`UDP`协议通讯，同时TCP也被支持__。`OpenVPN`连接能通过大多数的代理服务器，并且能够在`NAT`的环境中很好地工作。服务端具有向客户端“推送”某些网络配置信息的功能，这些信息包括：IP地址、路由设置等。`OpenVPN`提供了两种虚拟网络接口：通用`Tun/Tap`驱动，通过它们，可以建立三层`IP`隧道，或者虚拟二层以太网，后者可以传送任何类型的二层以太网络数据。传送的数据可通过`LZO`算法压缩。`IANA(Internet Assigned Numbers Authority)`指定给`OpenVPN`的官方端口为1194。`OpenVPN 2.0`以后版本每个进程可以同时管理数个并发的隧道。

`OpenVPN`使用通用网络协议(TCP与UDP)的特点使它成为`IPsec`等协议的理想替代，尤其是在`ISP(Internet service provider)`过滤某些特定`VPN`协议的情况下。在选择协议时候，需要注意2个加密隧道之间的网络状况，如有高延迟或者丢包较多的情况下，请选择`TCP`协议作为底层协议，`UDP`协议由于存在无连接和重传机制，导致要隧道上层的协议进行重传，效率非常低下。

#### 1.1.3.4 安全

`OpenVPN`与生俱来便具备了许多安全特性：在用户空间运行，无须对内核及网络协议栈作修改；初始完毕后以`chroot`方式运行，放弃`root`权限；使用`mlockall`以防止敏感数据交换到磁盘。

`OpenVPN`通过`PKCS#11`支持硬件加密标识，如智能卡。

## 1.2 VPN 原理及实现之一般理论

`OpenVPN`基于`OpenSSL`来实现安全，但是却不是传统意义上的`SSLVPN`，它只是一个普通的`VPN`，工作在`IP`层而不是传输层。

`VPN`的含义着重点有两层意思，一个是`V`，也就是虚拟，另一个是`P`，也就是专用。

虚拟就是说不用物理布线，仅仅在逻辑上实现一个网络，虚拟网络之所以能实现并建立起来，靠的是分层模型的优势，分层模型直接将网络按照逻辑意义纵向分成了7个层次(或者`TCP/IP`的5个层次)，每一层都仅仅承载数据而不管数据的格式和内容，上下层次间仅仅通过接口和服务来通信，理论上任何层次的数据都可以被承载在其它的任何层次或者它当前的层次上，于是就出现了很多`XX`over`YY`的网络模型，比较典型的比如`ppp over ethernet`等。

`over`模型按照数据层次可以分为三类，第一类是上层数据承载于下层，这实际上就是我们使用的普通的`TCP/IP`模型，第二类是同层承载，比如上面说的`pppoe`，这一类构建方式主要是为了在一个以传输占主导的层次上增加一个非传输意义的逻辑或者说实现一个隧道，比如`pppoe`中，`ethernet`主要用于局域网传输，而且性价比十分合理，但是却缺乏认证机制，但是`ppp`协议的认证功能虽然很好，但是却缺乏多点通信和寻址能力，作为传输协议意义不大，于是就使用`ethernet`进行传输，使用`ppp`进行认证，另外一个同层承载的例子是`IPSec`的隧道模式，它将一个`IP`数据报封装于另一个`IP`数据报中，这样实际上也就实现了一般意义上的“虚拟局域网络”(注意不是vlan)，因为在数据报到达最终目的地之前，参与路由的始终是外层的`IP`头，内层的`IP`头连同真实数据都被外层`IP`当成了`data`，因此不参与路由，所以从隧道的出发路由器到结束路由器，不管中间经过的是局域网，广域网还是别的什么，内层的`IP`数据报一直“以为”自己在出发路由器的那个局域网内，因此就实现了一个虚拟网络，实现了`VPN`中的`V`，那么`P`呢，`IPSec`将`V`和`P`做到了一起，也就是说在实现`ip over ip`的过程中实现了安全，这就是熟知的`ah`协议和`esp`协议，实现了安全才能保证专用，否则别人都可以进入你的虚拟网络了，作为`VPN`来说，`IPsec`就到此为止，但是`IPSec`的用处不光如此，`IPSec`主要是保证`IP`数据报的安全(因为`IP`层不提供任何安全保护，`ipv6`就不一样了，完全不需要`IPSec`)，`VPN`只是它的隧道模式的一个应用，除了隧道模式，`IPSec`还有传输模式，不建立隧道，只是将认证或者加密的功能置于`IP`数据报中，当然也就是不需要`ip over ip`了。

众所周知`IPSec`的隧道模式实现的`VPN`有一个缺陷，那就是很难穿越`nat`，因为`nat`要修改`IP`头，一旦`IP`头被修改了，那么最终的`ah`或者`esp`的认证加密的校验结果就会出错，因此就不能随意在`nat`的网络环境中使用`IPSec`实现的`VPN`，当然不涉及`IP`头认证的`IPSec`协议还是可以用的。

难道`VPN`就`IPSec`这一根稻草了吗？认证和加密的逻辑十分复杂和多样，不适合在`IP`层做，`IP`层做好快速路由和连接不同子网就够了，如果将分层模型的每个层次仅仅当作一种交通工具来看待的话，问题就容易解决了，交通工具或者叫运输工具可以相互运输，大卡车可以运小卡车，也可以拆了被小卡车运，大卡车还可以运输别的大卡车，它们都可以被放入集装箱被轮船运输，分层模型就是这样的，我们可以让应用层或者表示层或者传输层来承载`IP`数据报，这也就是`over`模型的第三类，即上层承载下层，很多时候越往上层逻辑越复杂，实现越灵活，如果想要在低层次实现高度复杂的逻辑，不妨试试这种模型，这个意义上看，`IPSec`实现的`VPN`最后肯定不如`ip over ssl`好，因为扩充`IPSec`很难，毕竟它在协议栈中的位置不适合做大幅修改，但是`ssl`的扩展性却很好，它本身就在协议栈的顶端，即使影响也就影响应用层，比如迫使`http`转换到`https`。

如果说底层就不该有复杂多样且多变的逻辑这种设计思想是对的，那么`IPsec`就不该出现，`IPv6`除了扩充地址空间外，新增的功能净加重了`IP`层的负担，`IPv6`的复杂设计净是商业公司为了推自己的接口或者设备而使出的伎俩，不过也说不准，留给历史评述吧。

`VPN`不一定要实现隧道，只要能互相访问并且保证互访者独占性的网络理论上都是`VPN`，然而隧道的方式更具有代表性，各种实现也更丰富和花哨。

## 1.3 VPN 原理及实现之隧道的一种实现

理论上已经合理的`ip over ssl`还需要一些额外的技术支撑才能使用，必须想办法将一个`ip`数据报原封不动的让它被`ssl`重新封装一次，这个动作不可能在原始的标准协议栈中执行，标准协议栈不支持数据双向流动，那么解决方案之一就是修改协议栈，在`ip`层之下实现一个轻量的`ssl`协议层，但是如此一来就又回到了`IPSec`的老路上，因此此法不可取，正确的方法是不修改协议栈，让一切留在它应该在的地方，于是`ssl`必然得在应用层或者说是表示层实现，现在的问题是如何将下层的`ip`数据报重新引入上面的应用层，而且还不能修改标准协议栈，于是必然地要让`ip`数据报继续往下走，然后最终从一个网卡流出，于是就出了协议栈，接下来就可以自由发挥了，让数据流出网卡的原因是不能修改协议栈，但是还不能真的让它流出机器，如果它走了就不能指望用`ssl`封装它了，那么流到哪里呢？回环设备是一个不错的选择，从回环设备流出的数据实际上又流进了回环设备，用户空间只需要打开回环设备然后读取就可以了，注意不能通过一般套接字读取，毕竟那些数据不是发给我们的，要使用类似抓包的方式进行数据抓取，并且用防火墙禁止被抓取的数据继续被`forward`，这实际上是一种巧妙的拦截方式，被抓取得数据然后经过`ssl`封装后再发向一个真的`ip`地址，我们需要配置的就是将所有的`vpn`数据全部发往回环设备，其实就是添加一条路由，虚拟网络已经建立，事情到此为止看似要结束了。

但是且慢，问题来了，以后所有`vpn`数据都会经标准协议栈流出再流进`loopback`，然后作为裸数据进入应用层，接着整个原始`vpn`数据连同它的原始`ip`头封装作为应用数据接受`ssl`协议的封装，然后发往`vpn`的另一端，在另一端数据从真实网卡进入，然后由于这是隧道的终点，数据直接进入应用层，在应用层，`vpn`服务器等候在那里，得到原始的`vpn`裸数据还有它在发送端的`ip`头，服务端得到这个东西有什么用呢，接下来它要怎么做呢，它只是隧道的终点，并不是真的要接收数据的机器，因此它必须将数据重新发到真正需要它的机器，很显然它要作为一个应用层代理存在，剥去原始的`ip`头，得到原始的数据，然后将数据发给真实的目的地，且不说此法是否可能，有两点不合理之处足以否定它，由于`vpn`服务器实现了代理，那么数据必然要在该处集中并剥去`ip`头，并且在相反的方向要做同样的处理，那么它就要记住所有的`ip`头，否则数据就会有去无回，如此一来，`vpn`服务器的负载可堪忍受？性能呢？第二点，代理的方式消除了隧道的透明性，目的地受到数据后会不知道数据从何而来，统一认为是`vpn`服务器发来的，这样就无法根据数据源点进行策略化服务。

综上原因，`loopback`设备可用但不可行，因为它是本机闭合的，也就是说只有`loopback`出去的数据才能进入`loopback`，它又且仅有两个出口，一读一写都在应用层，你无法将数据作为物理层的流写入`loopback`，而只能作为应用层的数据通过协议栈逐级封装到达`loopback`，然后再逐级解封回来，`vpn`发送端面临同样的问题，因为仅仅是路由将数据出口指向了`loopback`，如果不用抓包的方式(pcap)的话是得不到数据的，而这种方式又十分影响性能，加之还要配置复杂的防火墙规则禁止进入`loopback`的数据被转发，性能又受影响，隧道两端由于是全双工通信，因此一端面临的问题在数据反向时在对端同样存在，抛开这些不谈，仅就`loopback`无法自由配置`ip`地址这一条，它就不能被选中来实现隧道，`vpn`网络需要被管理，有时管理本身就很复杂，虚拟网络不仅仅就一张，我们需要为每张虚拟网络准备一个子网，也就是每个虚拟网络要有不同的`ip`，所以必然需要灵活的`ip`配置，故而`loopback`不能实现优雅透明的隧道，既然如此我们回到原点，无非就是做到两点，第一，数据必须按照协议栈的标准逐级封装和解封装，不能修改协议栈，第二就是数据到了最下面物理层的时候不能真的走掉，而是回到用户空间，于是乎虚拟网卡就成了很好的选择。

## 1.4 VPN 原理及实现之虚拟网卡构建 VPN

虚拟网卡通过实现一个字符设备来支持物理层，这样应用层和物理层就通过这个字符设备联系起来了，从这个字符设备读出来的就是虚拟网卡发往物理层的字节流，写入字符设备的数据作为字节流被虚拟网卡接收，虚拟网卡下面不再是网线或者无线电波，而是一个字符设备，这样从字符设备读出的还是写入字符设备的都是物理层字节流了，用它来实现隧道再简单不过了，`VPN`程序读取字符设备，得到封装好的原始数据，然后用`SSL`再封装后发往`VPN`的对端，和`loopback`的最初尝试一样，实现配置一条路由，使得要通过隧道的数据从虚拟网卡流出，最终通过虚拟网卡的字符设备导入应用层的`VPN`进程。

有了虚拟网卡，`VPN`隧道可以如上述很简单的实现，那么还有什么额外的工作要做呢？由于虚拟网卡的物理层可以通过字符设备随意读写，那么一台机器也就被虚拟成了两台机器，`VPN`进程可以被设想为运行在另一台机器上，而这台机器有一个网卡连接真实的机器，该网卡就是虚拟网卡，于是问题就转化成了两台机器通信的问题，这个很好办，完全通过路由就能搞定，因此额外的工作基本没有，并且我们也避开了抓包，代理等降低性能又很难扩展的概念。虚拟网卡实现的隧道非常灵活，需要做的仅仅是安装一个虚拟网卡驱动，然后配置一下路由即可，一切尽在我们所熟悉的`route`命令中搞定。数据流向见下图：

其实`IP`网络本身就是一个虚拟的网络，任何不通过导线直接相连通信的网络都是虚拟网络，难道`IP`网不是构建在各种局域网，广域网，电信网，电视网等物理网络之上的虚拟网络吗？按照分层的观点，`pstn`都可以看成是虚拟网络，`VPN`作为虚拟网络的意义更特殊罢了，而且实现的也各式各样，甚为巧妙。

`ip over ssl`没有触动协议栈，也没有增加新的协议，利用`SSL`的灵活性将`IP`封装的更加安全了，`SSL`比`IPSec`要灵活得多，应用层的`SSL`本身可配置性就比较好，不仅仅可以实现`IPSec`中`dh`密钥协商，还可以使用很多`pki`的优秀特性。开源软件一向不会放弃任何优秀的东西，`OpenVPN`就是用上述思想完成的，实际上`OpenVPN`几乎没有做什么，就是一个整合，整合什么呢？通读代码发现就是配置虚拟网卡，配置路由，读写字符设备，用`OpenSSL`的库进行`SSL`协议封装，几乎全部都是现有的东西，然而经过`OpenVPN`的整合就成了一个稳定又高效的`VPN`软件。

## 1.5 VPN 原理及实现之TCP还是UDP

## 1.6 Linux 平台 VPN 技术概论

## 1.7 Linux 平台 VPN 技术概论-续

## 1.8 VPN 技术漫谈之 IPSec(附MPLS)

## 1.9 TCP 封装的隧道对于拥塞控制的意义

## 1.10 VPN 的概念及要点

## 1.11 SSL VPN 和 IPSec VPN 的区别以及部署

# 2 基本编译配置篇

## 2.1 OpenVPN 简易文档

## 2.2 OpenVPN - 2.1.1在windows上的编译

## 2.3 Mac OS X上安装 OpenVPN

## 2.4 OpenVPN 碰到 Windows-一些问题的解决

## 2.5 OpenVPN 遇到的 Secondary 地址问题

# 3 源码分析篇

## 3.1 OpenVPN 的广播问题以及 tun 和 tap 设备的深层次挖掘

## 3.2 OpenVPN 中虚拟ip地址的自定义分配

## 3.3 OpenVPN 中虚拟ip地址的分配

## 3.4 OpenVPN 中虚拟ip地址的自定义分配--总结

## 3.5 OpenVPN 的日志记录头

## 3.6 使用 OpenVPN 时的问题--用源代码进行分析

## 3.7 OpenVPN 关于 push-peer-info 的实现

# 4 协议篇

## 4.1 OpenVPN 协议解析-网络结构之外

## 4.2 OpenVPN 协议解析-握手数据包分析

## 4.3 OpenVPN 协议解析-通道/状态机/Reliability层

# 5 高级路由篇

## 5.1 使用 OpenVPN 的桥接模式扩展内部局域网

## 5.2 OpenVPN 的高级路由技术-内部路由

## 5.3 OpenVPN 高级路由技术-扩展成巨大的网络

## 5.4 OpenVPN 高级路由技术-反向推送信息

## 5.5 OpenVPN 的包过滤机制

## 5.6 OpenVPN 高级路由技术-虚拟交换机和内部路由缓存

## 5.7 OpenVPN 高级路由技术-全面的互通性配置

# 6 性能相关

## 6.1 OpenVPN 的效率问题

## 6.2 OpenVPN 性能-数据采集

## 6.3 OpenVPN 性能-OpenVPN 的第一个瓶颈在tun驱动

## 6.4 OpenVPN 性能-OpenVPN 的第二个瓶颈在ssl加解密

## 6.5 OpenVPN 性能-当tap遇到bonding

## 6.6 OpenVPN 性能-多 OpenVPN 共享一个虚拟网卡

# 7 功能实现

OpenVPN 的新钩子设计
让 OpenVPN 实现IKE似的两阶段密钥协商
返璞归真实现 OpenVPN 第二阶段协商
完全在用户态实现 IPSec VPN

# 8 参考

* [网络7层协议，4层，5层？理清容易混淆的几个概念](https://blog.csdn.net/cc1949/article/details/79063439)
* [Socket 的功能 和 套接字的三种类型](https://blog.csdn.net/bjyddxhfxq/article/details/51119653)
* [Using Linux Raw Sockets](http://squidarth.com/networking/systems/rc/2018/05/28/using-raw-sockets.html)
* [原始套接字(SOCK_RAW)概述](https://cailin.iteye.com/blog/1985169)
* [vpn工作原理和搭建方法](https://yuerblog.cc/2017/01/03/how-vpn-works-and-how-to-setup-pptp/)
* [tun/tap运行机制](http://vinllen.com/tun-tap/)
* [虚拟网卡 TUN/TAP 驱动程序设计原理](https://www.ibm.com/developerworks/cn/linux/l-tuntap/index.html)
* [TUN/TAP设备浅析(一) -- 原理浅析](https://www.jianshu.com/p/09f9375b7fa7)
* [git-n2n](https://github.com/ntop/n2n/blob/dev/doc/HACKING)

