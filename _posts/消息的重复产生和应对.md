---
title: 消息的重复产生和应对
date: 2017-08-01 13:33:00
tags: 
- 摘录
categories: 
- 分布式
- 消息中间件
---

__阅读更多__

<!--more-->

# 1 消息重复产生的原因

消息重复产生的原因主要有两大类

__第一类原因是消息发送端应用的消息重复发送__

1. 消息发送端发送消息给消息中间件，消息中间件收到消息并成功存储，而这时消息中间件出现了问题，导致应用端没有收到消息发送成功的返回，因而进行重试产生了重复
1. 消息中间件因为负载高响应变慢，成功把消息存储到消息存储中后，返回"成功"这个结果时超时
1. 消息中间件将消息成功写入消息存储，在返回结果时网络出现问题，导致应用发送端重试，而重试时网络恢复，由此导致重复

__其主要原因是：消息成功进入消息存储后(不进入存储就不会出现重复了)，因为各种原因使得消息发送端没有收到"成功"的返回结果，并且又有重试机制，因而导致重复__

一个解决办法是，重试发送消息时使用同样的消息id，而不要在消息中间件端产生消息id，这样可以避免这类情况的发生

__第二类原因是消息到达了消息存储，由消息中间件进行向外投递时产生重复__

1. 消息被投递到消息接收者应用进行处理，处理完毕后应用出问题了，消息中间件不知道消息处理结果，会再次投递
1. 消息被投递到消息接收者应用进行处理，处理完毕后网络出现问题了，消息中间件没有收到消息处理结果，会再次投递
1. 消息被投递到消息接收者应用进行处理，处理时间比较长，消息中间件因为消息超时会再次投递
1. 消息被投递到消息接收者应用进行处理，处理完毕后消息中间件出问题了，没能收到消息结果并处理，会再次投递
1. 消息被投递到消息接收者应用进行处理，处理完毕后消息中间件收到结果，但是遇到消息存储故障，没能更新投递状态，会再次投递

__其主要原因是：消息接收者成功处理完消息后(没有处理完就不算重复了)，消息中间件不能及时更新投递状态造成的__

可以用分布式事务来解决，不过这种方式比较复杂，成本也较高。另一种方式就是要求消息接收者来处理这种重复的情况，也就是要求消息接收者的消息处理是幂等操作

> 幂等(idempotence)是一个数学概念，常见与抽象代数中。有两种主要的定义
> 1. 在某二元运算下，幂等元素是指被自己重复运算(对于函数则是复合)的结果等于它自身的元素
> 1. 在某一元运算为幂等时，其两次作用在任一元素后会和其作用一次的结果相同

因此对应消息重复的办法是，使消息接收端的处理是一个幂等操作。这样的做法降低了消息中间件的整体复杂性，不过也给使用消息中间件的消息接收端应用带来了一定的限制和门槛

# 2 参考

__本篇博客摘录、整理自以下博文。若存在版权侵犯，请及时联系博主(邮箱：liuyehcf#163.com，#替换成@)，博主将在第一时间删除__

* 大型网站系统与Java中间件实践
