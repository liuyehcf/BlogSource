---
title: Linux-DNS
date: 2018-12-02 10:42:02
tags: 
- 摘录
categories: 
- Operating System
- Linux
---

__阅读更多__

<!--more-->

# 1 什么是DNS

## 1.1 用网络主机名取得IP的历史渊源

__单一文件处理上网的年代：`/etc/hosts`__

* 利用某些特定的文件将主机名与IP做一个对应，如此一来，我们就可以通过主机名来取得该主机的IP了
* 但是主机名与IP的对应无法自动在所有计算机内更新，且要将主机名加入该文件仅能向INTERNIC注册，若IP数量太多时，该文件会过大，也就更不利于其他主机同步化了
* 在私有网络内部，最好将所有的私有IP与主机名对应都写入这个文件中

## 1.2 DNS的主机名对应IP的查询流程

### 1.2.1 DNS的阶层架构与TLD

__在整个DNS系统的最上方一定是`.`(小数点)这个DNS服务器，称为`root`__，最早在它下面管理的就只有`.com`、`.edu`、`.gov`、`.mil`、`.org`、`.net`这种特殊区域以及以国家为分类的第二层的主机名，这两者称为`Top Level Domains(TLDs)`

__一般顶级域名(Generic TLDs, gTLD)：例如`.com`、`.org`、`.gov`等__

__地区顶级层域名(Country Code TLDs, ccTLD)：例如`.uk`、`.jp`、`.cn`等__

__最早root管理六大领域域名，如下表：__

| 名称 | 代表意义 |
|:--|:--|
| `com` | 公司、行号、企业 |
| `org` | 组织、机构 |
| `edu` | 教育单位 |
| `gov` | 政府单位 |
| `net` | 网络、通信 |
| `mil` | 军事单位 |

### 1.2.2 授权与分层负责

1. 我们不能执行设置TLD，必须向上层ISP申请域名的授权才行
1. 每个国家之下记录的主要区域，基本与root管理的六大类类似
1. __每一个上层的DNS服务器所记录的信息，其实只有其下一层的主机名而已__
1. 这样设置的好处：每台机器管理的只有下一层的hostname对应的IP，所以减少了管理上的困扰，如果下层Client端如果有问题，只要询问上一层DNS Server即可，不需要跨越上层，排错也会比较简单

### 1.2.3 通过DNS查询主机名IP的流程

DNS是以类似树形目录的形态来进行主机名的管理的，所以每一台DNS服务器都仅管理自己的下一层主机名的转译，至于下层的下层，则授权给下层的DNS主机来管理

当你在浏览器地址输入`http://www.ksu.edu.tw`时，计算机会依据相关设置(在Linux下面就是利用`/etc/resolv.conf`这个文件)所提供的DNS(以`168.95.1.1`为例)的IP去进行连接查询

1. 收到用户的查询要求，先查看本身有没有记录，若无则向`.(root)`查询
1. 向最顶层的`.(root)`查询
    * 由于`.(root)`只记录了`.tw`的信息(因为台湾地区只有`.tw`向`.(root)`注册)
    * 从而转向`.tw`查询
1. 向第二层的`.tw`服务器查询
    * 这台机器`(.tw)`管理的仅仅有`.edu.tw`、`.com.tw`、`gov.tw`等
    * 转向`.edu.tw`这个区域的主机查询
1. 向第三层的`.edu.tw`服务器查询
    * 查询到`.ksu.edu.tw`的IP
    * 转向`.ksu.edu.tw`查询
1. 向第四层的`.ksu.edu.tw`服务器查询
    * 找到了`www.ksu.edu.tw`
1. 记录缓存并回报用户
    * DNS(168.95.1.1)会先记录一份查询结果在自己的缓存中，以方便响应下一次的相同要求

整个分层查询的流程就是这样，总要先经过`.(root)`来向下一层进行查询，这样分层的好处如下

1. 主机名修改的仅需要更改自己的DNS即可，不需要通知其他人
    * 只要你的主机名是经过上层合法的DNS服务器设置的，那么就可以在Internet上被查到
1. DNS服务器对主机名解析结果的缓存时间
    * 在缓存内的答案是有时间性的，通常是数十分钟到三天之内
    * 因此当修改了一个`domain name`后，可能要2-3天才能全面启用
1. 可持续向下授权(子域名授权)

`dig +trace www.ksu.edu.tw`：显示分层查询的过程

### 1.2.4 DNS使用的port number

DNS使用的port是`53`，在`/etc/services`这个文件搜寻`domain`关键词就可以查到53这个port
通常DNS是以UDP这个较快速的数据传输协议来查询，如果没有查到完整的信息，就会再次以TCP这个协议来重新查询，因此防火墙要放行TCP\UDP的port53

## 1.3 合法DNS的关键：申请区域查询授权

DNS服务器的架设还有合法与不合法之分，而不像其他服务器一样，架设好之后别人就查得到

向上层区域注册取得合法的区域查询授权

1. 申请一个合法的主机名就需要注册，注册就需要花钱
1. 注册取得的数据有两种
    * FQDN(主机名)：只需要主机名，详细的设置数据就由ISP帮我们搞定
    * 申请区域查询权：以`.ksu.edu.tw`为例，`.ksu.edu.tw`必须要向`.edu.tw`那台主机注册申请区域授权，未来有任何`.ksu.edu.tw`的要求时，`.edu.tw`都会转向`.ksu.edu.cn`，此时我们就需要架设DNS服务器来设置`.ksu.edu.tw`相关的主机名对应才行
1. 架设DNS，而且是可以连上Internet上面的DNS，就必须通过上层DNS服务器的授权才行
1. 让你的主机名对应IP且让其他计算机可以查询到，可以有如下两种方式
    * 上层DNS授权区域查询权，让你自己设置DNS服务器
    * 直接请上层DNS服务器来帮你设置主机名对应

拥有区域查询权后，所有的主机名信息都以自己为准，与上层无关。DNS系统记录的信息非常多，重点有两个

1. __记录服务器所在的NS(NameServer)标志__
1. __记录主机名对应的A(Address)标志__
1. __架设的DNS主机在其上层DNS主机中记录的是NS标志__

## 1.4 主机名交由ISP代管还是自己设置DNS服务器

无论如何你只有两个选择

1. 请上层DNS帮你设置好Hostname与IP
1. 请上层DNS将某个domain name段授权给你作为DNS的主要管理区域

需要架设DNS的时机

1. 你所负责需要连上Internet的主机数量庞大，例如负责公司几十台的网络Server，而这些Server都是挂载在你公司的区域之下
1. 你可能需要时常修改你的Server的名字，或者你的Server有随时增加的可能性与变动性

不需要架设DNS的时机

1. 网络主机数量很少
1. 你可以直接请上层DNS主机管理员帮你设置好Hostname的对应
1. 你对于DNS的认知不足，如果架设反而容易造成网络不通的情况
1. 架设DNS费用很高

## 1.5 DNS数据库的记录：正解、反解、Zone的意义

记录的东西可以称为数据库，在数据库里针对每个要解析的域(domain)，就称为一个区域(zone)

__概念__：

1. 正解：从主机名查询到IP的流程
1. 反解：从IP反解析到主机名的流程
1. 无论正解还是反解，每个域记录的就是一个区域(zone)
1. 举例来说
    * 昆山科大DNS服务器管理的就是`*.ksu.edu.tw`这个域的查询权，任何想要知道`*.ksu.edu.tw`主机名的IP都得向昆山科大的DNS服务器查询，此时`.ksu.edu.tw`就是一个“正解的区域”
    * 昆山科大有几个`Class C`的子域，例如`120.114.140.0/24`，如果这254个可用IP都要设置主机名，那么这个`120.114.140.0/24`就是一个“反解的区域”

__正解的设置权以及DNS正解Zone记录的标志__

1. 只要改域没有人使用，那谁先抢到了，就能够使用了
1. 正解的Zone通常有以下几种标志
    * `SOA`：就是开始验证(Start of Authority)的缩写
    * `NS`：就是名称服务器(Name Server)的缩写，后面记录的数据时DNS服务器
    * `A`：就是地址(Address)的缩写，后面记录的是IP的对应

__反解的设置权以及DNS反解Zone记录的标志__

1. 反解主要是由IP找到主机名，重点是IP所有人是谁
1. IP都是INTERNIC发放给各家ISP的，而且IP不能乱设置（路由问题）
1. __因此能够设置反解的就只有IP的拥有人，亦即ISP才有权利设置反解__
1. 除非你取得是整个`Class C`以上等级的IP网段，那你的ISP才可能给你IP反解授权，否则，若有反解的需求，就需要向你的直属上层ISP申请才行
1. 反解的Zone记录的主要信息如下：
    * `NS`
    * `SOA`
    * `PTR`：就是指向(PoinTeR)的缩写，后面记录的数据就是反解到的主机名

每台DNS都需要的正解`Zone：hint`

1. 一个正解或一个反解就可以称为一个`Zone`了
1. `.`这个`Zone`是最重要的
    * 当DNS服务器在自己的数据找不到所需的信息时，一定会去找`.`
    * 因此就必须具有记录`.`在哪里的记录`Zone`才行
    * 这个记录`.`的`Zone`类型，就被称为`hint`类型，这个几乎是每个DNS服务器都需要知道的`Zone`
1. 一台简单的正解DNS服务器，基本就要有两个`Zone`才行，一个是`hint`，一个是关于自己域的正解`Zone`

正反解是否一定要成对

1. 正反解不需要成对
1. 在很多情况下，常常会只有正解的设置需求
1. 事实上，需要正反解成对需求的大概仅有`Mail Server`，由于目前网络带宽经常被垃圾邮件、广告邮件占光，所以Internet的社会对于合法的`Mail Server`规定也就越来越严格

## 1.6 DNS数据库的类型：hint、Master/Slave架构

现在注册域名，那么ISP都会要求你填写两台DNS服务器的IP，因为需要作为备份之用

1. 如果有两台以上的DNS服务器，那么网络上会搜寻到哪一台是不确定的，因为是随机的
1. 这两台DNS服务器的内容必须一模一样，如果不同步将会造成用户无法取得正确数据的问题
1. 为了解决这个问题，因此在`.(root)`这个`hint`类型的数据库文件外，还有两种基本类型
    * `Master`(主人，主要)数据库
    * `Slave`(奴隶，次要)数据库

__Master__

1. 这种类型的DNS数据库中，里面所有的主机名相关信息，都需要管理员自己手动去修改与设置，设置完毕后还需要重新启动DNS服务去读取正确的数据库内容，才算完成数据库更新
1. 一般来说，我们说的DNS架设，就是指这种数据库的类型
1. 同时这种类型的数据库，还能够提供数据库内容给`Slave`的DNS服务器

__Slave__

1. 通常不会只有一台DNS服务器，如果每台DNS都使用Master数据库类型，当有用户想我们要求修改或添加、删除数据时，一笔数据就需要做三次
1. `Slave`必须与`Master`相互搭配
1. 假如有三台主机提供DNS服务，且三台内容相同，那么只需要指定一台服务器为Master，其他两台为该Master的Slave服务器，那么当要修改的一笔名称对应时，我们只要手动更改Master那台机器的配置文件，然后重新启动BIND这个服务后，其他两台Slave就会自动被通知更新了

__Master/Slave的查询优先权__

1. 不论是`Master`还是`Slave`服务器，都必须可以同时提供DNS服务才行，因为在DNS系统中，域名的查询是“先进先出”的状态
1. 每一台DNS服务器的数据库内容需要完全一致，否则就会造成客户端找到的IP是错误的

__Master/Slave数据的同步化过程__

1. `Slave`需要更新来自`Master`的数据，所以当然`Slave`在设置之初就需要存在`Master`才行
1. 不论`Master`还是`Slave`数据库，都会有一个代表该数据库新旧的“序号”，这个序号数值的大小，是会影响是否要更新的操作
1. 更新的方式主要有以下两种
    * __Master主动告知__：在Master修改了数据库内容，并加大数据库序号后，重新启动DNS服务，那Master会主动告知Slave来更新数据库，此时能实现数据同步
    * __Slave主动提出要求__：Slave会定时向Master查看数据库的序号，当发现Master数据库序号比Slave序号更大时，那么Slave就会开始更新，如果序号不变，就判断数据库没有变动，不会进行同步更新

# 2 Client端的设置

## 2.1 相关配置文件

__问题：__

1. 从主机名对应到IP有两种方法，`/etc/hosts`或者通过DNS架构
1. 那么这两种方法分别使用什么配置文件
1. 可否同时存在
1. 若可以同时存在，哪种优先

__如下几个配置文件__

1. `/etc/hosts`：最早的Hostname对应IP的文件
1. `/etc/reslov.conf`：就是ISP的DNS服务器IP记录处
1.` /etc/nsswitch.conf`：决定先使用`/etc/hosts`还是`/etc/reslov.conf`的设置

__一般而言，默认的Linux主机与IP的对应解析都以/etc/hosts优先__

__`/etc/resolv.conf`__

1. DNS服务器的IP可以设置多个，为什么要多个(避免DNS服务器宕机找不到IP)，有点类似DNS备份功能
1. 在正常情况下，永远只有第一台DNS服务器会被用来查询
1. 为什么`/etc/resolv.conf`内容会被自动修改
    * 当使用DHCP时，系统会主动使用DHCP服务器传来的数据进行系统配置文件的修订
    * 如果不想使用DHCP传来的服务器设置值，可以在/etc/sysconfig/network-scripts/ifcfg-eth0等相关文件内增加`PEERDNS=no`一行，然后重新启动即可

## 2.2 DNS的正解、反解查询命令：host、nslookup、dig

### 2.2.1 host

__格式：__

* `host [-a] FQDN [server]`
* `host -l domain [server]`

__参数说明：__

* `-a`：代表列出该主机所有的相关信息，包括IP、TTL与排错信息等
* `-l`：若后面接的那个domian设置允许allow-transfer时，则列出该domain所管理的所有主机名对应数据
* `server`：这个参数可有可无，当想要利用非`/etc/resolv.conf`内的DNS主机来查询主机名与IP的对应时，就可以利用这个参数了

### 2.2.2 nslookup

__格式：__

* `nslookup [FQDN] [server]`
* `nslookup`

### 2.2.3 dig

__格式：__

* `dig [option] FQDN [@server]`

__参数说明：__

* `+trace`：从`.`开始追踪
* `-t type`：查询的数据主要有MX，NS，SOA等类型
* `-x`：查询反解信息，非常重要
* `@server`：如果不以`/etc/resolv.conf`的设置来作为DNS查询，可在此填入其他的IP

__查询结果介绍__

1. 整个显示出的信息包括以下几个部分
1. QUESTION(问题)：显示所要查询的内容
1. ANSWER(回答)：依据刚刚的QUESTION去查询所得到的结果
1. AUTHORITY(验证)：查询结果是由哪台服务器提供的(好像没有了???)

__示例：__

* `dig linux.vbird.org`
* `dig -x 120.114.100.20`

### 2.2.4 whois

whiois用于查询这个域是谁管的

# 3 参考

* 《鸟哥的Linux私房菜：服务器架设篇（第三版）》
